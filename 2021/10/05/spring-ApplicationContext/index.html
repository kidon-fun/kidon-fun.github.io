<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Spring源码学习—— ApplicationContext | 啓東のblogs</title><meta name="description" content="Spring源码学习—— ApplicationContext"><meta name="keywords" content="spring"><meta name="author" content="Kidon"><meta name="copyright" content="Kidon"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon1.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring源码学习—— ApplicationContext"><meta name="twitter:description" content="Spring源码学习—— ApplicationContext"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Spring源码学习—— ApplicationContext"><meta property="og:url" content="https://kidon.fun/2021/10/05/spring-ApplicationContext/"><meta property="og:site_name" content="啓東のblogs"><meta property="og:description" content="Spring源码学习—— ApplicationContext"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'true'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://kidon.fun/2021/10/05/spring-ApplicationContext/"><link rel="prev" title="springboot源码阅读——@SpringBootApplication" href="https://kidon.fun/2022/03/07/study-in-springboot/"><link rel="next" title="Spring源码学习—— BeanFactory" href="https://kidon.fun/2021/10/04/spring-BeanFactory/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://kidon.fun/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"top-right"},
  baiduPush: true,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 5.4.1"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">啓東のblogs</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">4</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#ApplicationContext"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">ApplicationContext</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#EnvironmentCapable"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">EnvironmentCapable</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#StandardEnvironment"><span class="toc_mobile_items-number">1.1.1.</span> <span class="toc_mobile_items-text">StandardEnvironment</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#ApplicationEventPublisher"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">ApplicationEventPublisher</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#ApplicationEvent"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">ApplicationEvent</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#ApplicationContextEvent"><span class="toc_mobile_items-number">1.2.1.1.</span> <span class="toc_mobile_items-text">ApplicationContextEvent</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#ApplicationListener"><span class="toc_mobile_items-number">1.2.1.2.</span> <span class="toc_mobile_items-text">ApplicationListener</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#ApplicationEventMulticaster"><span class="toc_mobile_items-number">1.2.1.3.</span> <span class="toc_mobile_items-text">ApplicationEventMulticaster</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#ResourceLoader"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">ResourceLoader</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#MessageSource"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">MessageSource</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AbstractApplicationContext"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">AbstractApplicationContext</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#BeanFactoryPostProcessor"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">BeanFactoryPostProcessor</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#DefaultLifecycleProcessor"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">DefaultLifecycleProcessor</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#AbstractApplicationContext%E7%9A%84%E6%B6%89%E5%8F%8A%E7%9A%84Context%E6%A0%B8%E5%BF%83%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">AbstractApplicationContext的涉及的Context核心启动流程</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#refresh"><span class="toc_mobile_items-number">2.3.1.</span> <span class="toc_mobile_items-text">refresh()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#prepareRefresh"><span class="toc_mobile_items-number">2.3.2.</span> <span class="toc_mobile_items-text">prepareRefresh()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#obtainFreshBeanFactory"><span class="toc_mobile_items-number">2.3.3.</span> <span class="toc_mobile_items-text">obtainFreshBeanFactory()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#prepareBeanFactory"><span class="toc_mobile_items-number">2.3.4.</span> <span class="toc_mobile_items-text">prepareBeanFactory()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#postProcessBeanFactory"><span class="toc_mobile_items-number">2.3.5.</span> <span class="toc_mobile_items-text">postProcessBeanFactory()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#invokeBeanFactoryPostProcessors"><span class="toc_mobile_items-number">2.3.6.</span> <span class="toc_mobile_items-text">invokeBeanFactoryPostProcessors()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#registerBeanPostProcessors"><span class="toc_mobile_items-number">2.3.7.</span> <span class="toc_mobile_items-text">registerBeanPostProcessors()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#initMessageSource"><span class="toc_mobile_items-number">2.3.8.</span> <span class="toc_mobile_items-text">initMessageSource()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#initApplicationEventMulticaster"><span class="toc_mobile_items-number">2.3.9.</span> <span class="toc_mobile_items-text">initApplicationEventMulticaster()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#onRefresh"><span class="toc_mobile_items-number">2.3.10.</span> <span class="toc_mobile_items-text">onRefresh()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#registerListeners"><span class="toc_mobile_items-number">2.3.11.</span> <span class="toc_mobile_items-text">registerListeners()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#finishBeanFactoryInitialization"><span class="toc_mobile_items-number">2.3.12.</span> <span class="toc_mobile_items-text">finishBeanFactoryInitialization()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#finishRefresh"><span class="toc_mobile_items-number">2.3.13.</span> <span class="toc_mobile_items-text">finishRefresh()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#registerShutdownHook"><span class="toc_mobile_items-number">2.3.14.</span> <span class="toc_mobile_items-text">registerShutdownHook()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#doClose"><span class="toc_mobile_items-number">2.3.15.</span> <span class="toc_mobile_items-text">doClose()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%85%B6%E4%BB%96"><span class="toc_mobile_items-number">2.3.16.</span> <span class="toc_mobile_items-text">其他</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AbstractRefreshableApplicationContext"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">AbstractRefreshableApplicationContext</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#refreshBeanFactory"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">refreshBeanFactory()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#closeBeanFactory-%E5%92%8CgetBeanFactory"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">closeBeanFactory()和getBeanFactory</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E5%85%B6%E4%BB%96-1"><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">其他</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AbstractRefreshableConfigApplicationContext"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">AbstractRefreshableConfigApplicationContext</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AbstractXmlApplicationContext"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">AbstractXmlApplicationContext</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#ClassPathXmlApplicationContext"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">ClassPathXmlApplicationContext</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ApplicationContext"><span class="toc-number">1.</span> <span class="toc-text">ApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EnvironmentCapable"><span class="toc-number">1.1.</span> <span class="toc-text">EnvironmentCapable</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardEnvironment"><span class="toc-number">1.1.1.</span> <span class="toc-text">StandardEnvironment</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ApplicationEventPublisher"><span class="toc-number">1.2.</span> <span class="toc-text">ApplicationEventPublisher</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ApplicationEvent"><span class="toc-number">1.2.1.</span> <span class="toc-text">ApplicationEvent</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ApplicationContextEvent"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">ApplicationContextEvent</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ApplicationListener"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">ApplicationListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ApplicationEventMulticaster"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">ApplicationEventMulticaster</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ResourceLoader"><span class="toc-number">1.3.</span> <span class="toc-text">ResourceLoader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MessageSource"><span class="toc-number">1.4.</span> <span class="toc-text">MessageSource</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractApplicationContext"><span class="toc-number">2.</span> <span class="toc-text">AbstractApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanFactoryPostProcessor"><span class="toc-number">2.1.</span> <span class="toc-text">BeanFactoryPostProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultLifecycleProcessor"><span class="toc-number">2.2.</span> <span class="toc-text">DefaultLifecycleProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractApplicationContext%E7%9A%84%E6%B6%89%E5%8F%8A%E7%9A%84Context%E6%A0%B8%E5%BF%83%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">AbstractApplicationContext的涉及的Context核心启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#refresh"><span class="toc-number">2.3.1.</span> <span class="toc-text">refresh()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prepareRefresh"><span class="toc-number">2.3.2.</span> <span class="toc-text">prepareRefresh()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#obtainFreshBeanFactory"><span class="toc-number">2.3.3.</span> <span class="toc-text">obtainFreshBeanFactory()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prepareBeanFactory"><span class="toc-number">2.3.4.</span> <span class="toc-text">prepareBeanFactory()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#postProcessBeanFactory"><span class="toc-number">2.3.5.</span> <span class="toc-text">postProcessBeanFactory()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invokeBeanFactoryPostProcessors"><span class="toc-number">2.3.6.</span> <span class="toc-text">invokeBeanFactoryPostProcessors()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#registerBeanPostProcessors"><span class="toc-number">2.3.7.</span> <span class="toc-text">registerBeanPostProcessors()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#initMessageSource"><span class="toc-number">2.3.8.</span> <span class="toc-text">initMessageSource()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#initApplicationEventMulticaster"><span class="toc-number">2.3.9.</span> <span class="toc-text">initApplicationEventMulticaster()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#onRefresh"><span class="toc-number">2.3.10.</span> <span class="toc-text">onRefresh()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#registerListeners"><span class="toc-number">2.3.11.</span> <span class="toc-text">registerListeners()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#finishBeanFactoryInitialization"><span class="toc-number">2.3.12.</span> <span class="toc-text">finishBeanFactoryInitialization()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#finishRefresh"><span class="toc-number">2.3.13.</span> <span class="toc-text">finishRefresh()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#registerShutdownHook"><span class="toc-number">2.3.14.</span> <span class="toc-text">registerShutdownHook()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#doClose"><span class="toc-number">2.3.15.</span> <span class="toc-text">doClose()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">2.3.16.</span> <span class="toc-text">其他</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractRefreshableApplicationContext"><span class="toc-number">3.</span> <span class="toc-text">AbstractRefreshableApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#refreshBeanFactory"><span class="toc-number">3.1.</span> <span class="toc-text">refreshBeanFactory()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#closeBeanFactory-%E5%92%8CgetBeanFactory"><span class="toc-number">3.2.</span> <span class="toc-text">closeBeanFactory()和getBeanFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-1"><span class="toc-number">3.3.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractRefreshableConfigApplicationContext"><span class="toc-number">4.</span> <span class="toc-text">AbstractRefreshableConfigApplicationContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractXmlApplicationContext"><span class="toc-number">5.</span> <span class="toc-text">AbstractXmlApplicationContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassPathXmlApplicationContext"><span class="toc-number">6.</span> <span class="toc-text">ClassPathXmlApplicationContext</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Spring源码学习—— ApplicationContext</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2021-10-05<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2021-10-05</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head><script src="\assets\js\APlayer.min.js"> </script></head><body><p>![image-20211005154324577](/Users/mac/Library/Application Support/typora-user-images/image-20211005154324577.png)</p>
<h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContext</span> <span class="keyword">extends</span> <span class="title">EnvironmentCapable</span>, <span class="title">ListableBeanFactory</span>, <span class="title">HierarchicalBeanFactory</span>,</span></span><br><span class="line"><span class="class">      <span class="title">MessageSource</span>, <span class="title">ApplicationEventPublisher</span>, <span class="title">ResourcePatternResolver</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><em>context</em>上下文体系是spring在<code>BeanFactory</code>上的进一步扩展，增添了许多能力，比如环境变量、国际化、生命周期、Spring应用事件以及bean工厂的后置处理等。</p>
<p>而一个<code>ApplicationContext</code>的实现类应该至少具备以下能力：</p>
<ul>
<li>BeanFacory中访问Bean的方法（其继承了<code>ListableBeanFactory</code>）</li>
<li>以一种通用风格的形式加载文件资源的能力（其继承了<code>ResourceLoader</code>）</li>
<li>发布事件给已注册<em>listeners</em>的能力（其继承了<code>ApplicationEventPublisher</code>）</li>
<li>处理文本信息、支持国际化的能力（其继承了<code>MessageSource</code>）</li>
<li>继承父context的能力，后代优先级更高</li>
</ul>
<p>此外，还有标准的<code>BeanFactory</code>生命周期能力、检测并调用<code>ApplicationContextAware</code>、<code>ResourceLoaderAware</code>、<code>ApplicationEventPublisherAware</code>、<code>MessageSourceAware</code>等bean</p>
<p><code>BeanFactory</code>体系这里就不多描述了，主要介绍下其他的接口能力。</p>
<h3 id="EnvironmentCapable"><a href="#EnvironmentCapable" class="headerlink" title="EnvironmentCapable"></a>EnvironmentCapable</h3><p>此接口从命名上来看就是用来获取<code>Environment</code>变量的。这里我们主要介绍Spring中的环境变量体系。</p>
<p>从实现方法上看，我们发现Spring中默认使用的是<code>StandardEnvironment</code>对象。</p>
<h4 id="StandardEnvironment"><a href="#StandardEnvironment" class="headerlink" title="StandardEnvironment"></a>StandardEnvironment</h4><p>![image-20211005155220380](/Users/mac/Library/Application Support/typora-user-images/image-20211005155220380.png)</p>
<ul>
<li><p><code>PropertyResolver</code> </p>
<p>定义了获取属性的方法以及如何解析<code>${...}</code></p>
</li>
<li><p><code>ConfigurablePropertyResolver</code></p>
<p>在<code>PropertyResolver</code> 的基础上增添了配置能力，比如一些前后缀、分隔符、是否忽略无法嵌套解析的错误、设置必须具备的<em>properties</em>和验证<em>properties</em>。此外，还加入<code>ConfigurableConversionService</code>用以类型转换。</p>
</li>
<li><p><code>Environment</code> </p>
<p>spring中环境变量的抽象，环境有两类，分别是<strong>profiles</strong>和<strong>properties</strong>。</p>
<ul>
<li>只有给定<em>profile</em>是激活的，关联的BeanDefinition才会被注册</li>
<li>properties有多种来源：properties文件、jvm系统变量、系统环境变量、JNDI等等，而不同的来源优先级也是有所差异</li>
</ul>
</li>
<li><p><code>ConfigurableEnvironment</code></p>
<p>此接口主要新增了操作属性源(<code>MutablePropertySources</code>)的能力，还有设置、添加<em>profile</em>，获取系统属性和系统环境变量，合并其他<code>ConfigurableEnvironment</code>。</p>
</li>
<li><p><code>MutablePropertySources</code></p>
<p><code>AbstractEnvironment</code>默认使用的属性源管理类，其内部用<code>List</code>来管理<code>PropertySource</code>(属性源的抽象)，具有优先级关系，<strong>列表前头的优先级高</strong>。</p>
</li>
<li><p><code>AbstractEnvironment</code></p>
<p>其构造方法中使用了<strong>模板方法</strong>供子类自定义属性源。其还提供了实现接口的方法实现，比如属性字符串解析、获取系统属性和系统环境变量等。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MutablePropertySources propertySources = <span class="keyword">new</span> MutablePropertySources();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractEnvironment</span><span class="params">()</span> </span>{customizePropertySources(<span class="keyword">this</span>.propertySources);}</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizePropertySources</span><span class="params">(MutablePropertySources propertySources)</span> </span>{}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><code>StandardEnvironment</code></p>
<p>Spring中默认的环境变量对象，主要就是使用系统属性和系统环境变量。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizePropertySources</span><span class="params">(MutablePropertySources propertySources)</span> </span>{</span><br><span class="line">    propertySources.addLast(</span><br><span class="line">        <span class="keyword">new</span> PropertiesPropertySource(SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME, getSystemProperties()));</span><br><span class="line">    propertySources.addLast(</span><br><span class="line">        <span class="keyword">new</span> SystemEnvironmentPropertySource(SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME, getSystemEnvironment()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<h3 id="ApplicationEventPublisher"><a href="#ApplicationEventPublisher" class="headerlink" title="ApplicationEventPublisher"></a>ApplicationEventPublisher</h3><p><code>ApplicationEvent</code>的发布器。用于发布<code>ApplicationEvent</code>，如果事件不是<code>ApplicationEvent</code>会被包装成<code>PayloadApplicationEvent</code>，**其发布动作委托给了<code>ApplicationEventMulticaster</code>**。</p>
<p>Spring中的事件发布—监听模型主要涉及到三个基础对象：<code>ApplicationEvent</code>、<code>ApplicationListener</code>以及<code>ApplicationEventMulticaster</code>。</p>
<h4 id="ApplicationEvent"><a href="#ApplicationEvent" class="headerlink" title="ApplicationEvent"></a>ApplicationEvent</h4><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationEvent</span> <span class="keyword">extends</span> <span class="title">EventObject</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>ApplicationEvent</code>中记录了事件源和发生时间。Spring框架生命周期的时间主要有<code>ApplicationContextEvent</code>和<code>SpringApplicationEvent</code>，前者是<code>ApplicationContext</code>的周期事件，而后者是<strong>Springboot</strong>应用的周期事件，这里主要描述的是前者。</p>
<h5 id="ApplicationContextEvent"><a href="#ApplicationContextEvent" class="headerlink" title="ApplicationContextEvent"></a><code>ApplicationContextEvent</code></h5><ul>
<li><code>ContextClosedEvent</code> 关闭<code>ApplicationContext</code>时（关闭时会销毁singletons和工厂）</li>
<li><code>ContextRefreshedEvent</code> 完成<code>ApplicationContext</code>刷新时（每次调用<code>refresh()</code>）</li>
<li><code>ContextStoppedEvent</code> 停止<code>ApplicationContext</code>时（停止时会调用生命周期处理函数的stop方法）</li>
<li><code>ContextStartedEvent</code> 启动<code>ApplicationContext</code>完时（调用start方法）</li>
</ul>
<h5 id="ApplicationListener"><a href="#ApplicationListener" class="headerlink" title="ApplicationListener"></a><code>ApplicationListener</code></h5><p>泛型接口，不单是Spring应用事件，用户还可以实现对关注的事件类型的监听</p>
<h5 id="ApplicationEventMulticaster"><a href="#ApplicationEventMulticaster" class="headerlink" title="ApplicationEventMulticaster"></a><code>ApplicationEventMulticaster</code></h5><p>用于管理<em>Listeners</em>并且发布感兴趣的事件给他们。若用户未指定，则其默认使用的实现类是<code>SimpleApplicationEventMulticaster</code>。</p>
<ul>
<li><p><code>AbstractApplicationEventMulticaster</code>管理<em>listeneres</em></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用两个Set来存放所有的Listener(和bean name)，用两个的原因是Listener分为单例和非单例的</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ListenerRetriever defaultRetriever = <span class="keyword">new</span> ListenerRetriever(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 缓存，key为eventType(包装成`ResolvableType`)和sourceType的组合，value为符合key的所有Listener</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;ListenerCacheKey, ListenerRetriever&gt; retrieverCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br><span class="line"><span class="comment">// 对于Listener的变更需要同步处理</span></span><br><span class="line"><span class="keyword">private</span> Object retrievalMutex = <span class="keyword">this</span>.defaultRetriever;</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><code>SimpleApplicationEventMulticaster</code>发布事件</p>
 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 发布事件给对应的监听者 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> </span>{</span><br><span class="line">    <span class="comment">// 将eventType封装成`ResolvableType`</span></span><br><span class="line">    ResolvableType type = (eventType != <span class="keyword">null</span> ? eventType : resolveDefaultEventType(event));</span><br><span class="line">    Executor executor = getTaskExecutor();</span><br><span class="line">    <span class="comment">// getApplicationListeners方法用于获取和筛选监听该事件的listeners</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) {</span><br><span class="line">        <span class="keyword">if</span> (executor != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 如果配置了线程池，则用线程池异步执行</span></span><br><span class="line">            executor.execute(() -&gt; invokeListener(listener, event));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 未配置线程池，则采用caller run方式执行</span></span><br><span class="line">            invokeListener(listener, event);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
</ul>
<h3 id="ResourceLoader"><a href="#ResourceLoader" class="headerlink" title="ResourceLoader"></a>ResourceLoader</h3><p>用于解析符合某些规则的路径字符串，并返回符合规则的对应路径的<code>Resource</code>，实现类比如<code>PathMatchingResourcePatternResolver </code>。</p>
<h3 id="MessageSource"><a href="#MessageSource" class="headerlink" title="MessageSource"></a>MessageSource</h3><p>国际化相关的类，若服务需要夸语言夸地区等会很有用。由于工作中实际上几乎未使用过，故不叙述。</p>
<hr>
<h2 id="AbstractApplicationContext"><a href="#AbstractApplicationContext" class="headerlink" title="AbstractApplicationContext"></a>AbstractApplicationContext</h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractApplicationContext</span> <span class="keyword">extends</span> <span class="title">DefaultResourceLoader</span></span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">ConfigurableApplicationContext</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>AbstractApplicationContext</code>是Context体系下的核心类，核心方法和通用方法都在其中有实现。其未指定配置的储存形式，采用模板方法供子类定制化。</p>
<p>相比于普通的<em>BeanFactory</em>，<em>ApplicationContext</em>会检测其内部bean factory中定义的特殊bean。因此，本类会自动注册一些<code>BeanFactoryPostProcessors</code>、<code>BeanPostProcessors</code>和<code>ApplicationListeners</code>。</p>
<p>接下来介绍<code>BeanFactoryPostProcessor</code>和<code>DefaultLifecycleProcessor</code>，其在<code>Context</code>的启动过程或生命周期有着重要的作用</p>
<h3 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h3><p><code>BeanFactory</code>的后置处理器。其在所有的<code>BeanDefinition</code>加载后，任意bean实例化之前调用；它能够调整<code>BeanFacoty</code>的配置项，也能够修改<em>BeanDefinition</em>的属性（这可能将导致bean的提前实例化）；后置处理器的应用有顺序，如果是自动检测，则根据<code>PriorityOrdered</code>和<code>Ordered </code>接口排序（<code>@Order</code>注解无效），如果是编程注册，则按照注册的先后来排序（忽略排序接口）。</p>
<p>应用方面，比如<code>ConfigurationClassPostProcessor</code>用于解析<code>@Configuration</code>并将<code>BeanDefinition</code>注册到容器中。</p>
<h3 id="DefaultLifecycleProcessor"><a href="#DefaultLifecycleProcessor" class="headerlink" title="DefaultLifecycleProcessor"></a>DefaultLifecycleProcessor</h3><p><code>DefaultLifecycleProcessor</code>其主要作用是检测出实现了<code>Lifecycle</code>和<code>SmartLifecycle</code>的bean，并在的start和stop中触发对应<code>Lifecycle</code>方法。在<code>SmartLifecycle</code>中，调用的顺序由<em>phase</em>决定（在实现中根据phase分组），<strong>数值越小越先启动，数值越大越先销毁</strong>（<code>Lifecycle</code>默认为0）。</p>
<p>接下来就叙述<code>Context</code>的启动流程</p>
<h3 id="AbstractApplicationContext的涉及的Context核心启动流程"><a href="#AbstractApplicationContext的涉及的Context核心启动流程" class="headerlink" title="AbstractApplicationContext的涉及的Context核心启动流程"></a>AbstractApplicationContext的涉及的Context核心启动流程</h3><p>以<code>ClassPathXmlApplicationContext</code>举例，在其构造函数中会调用<code>AbstractApplication.refresh()</code>方法，当然其他的实现类也会调用这个方法。我们就<code>refresh()</code>为切入点，后面还有<code>doClose()</code>等方法的讲述。</p>
<h4 id="refresh"><a href="#refresh" class="headerlink" title="refresh()"></a><code>refresh()</code></h4><p><code>Context</code>中最核心的逻辑。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>{</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) {<span class="comment">// 整个刷新过程只能有一个线程操作</span></span><br><span class="line">            <span class="comment">// 准备Context的刷新，主要设置一些启动时间、活跃标志以及初始化PropertySouces，</span></span><br><span class="line">            <span class="comment">// 此外，还有early listeners和early evnets的处理</span></span><br><span class="line">            prepareRefresh();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 获取`ConfigurableListableBeanFactory`，主要的获取或者刷新方法由子类实现</span></span><br><span class="line">            ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 配置上一步获取的`beanFactory`，为实例化bean做准备</span></span><br><span class="line">            prepareBeanFactory(beanFactory);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 空方法，允许子类后置处理'beanFactory'</span></span><br><span class="line">                postProcessBeanFactory(beanFactory);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 调用`BeanFactoryPostProcessors`</span></span><br><span class="line">                invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 注册`BeanPostProcessors`</span></span><br><span class="line">                registerBeanPostProcessors(beanFactory);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 初始化'messageSource'</span></span><br><span class="line">                initMessageSource();</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 初始化'applicationEventMulticaster'</span></span><br><span class="line">                initApplicationEventMulticaster();</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 空方法，允许子类实例化一些特殊的bean</span></span><br><span class="line">                onRefresh();</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 注册`ApplicationListeners`并且发布'early events'</span></span><br><span class="line">                registerListeners();</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 实例化所有non-lazy的单例</span></span><br><span class="line">                finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 完成刷新：`LifecycleProcessor.onRefresh`和发布`ContextRefreshedEvent`事件</span></span><br><span class="line">                finishRefresh();</span><br><span class="line">            }</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) {</span><br><span class="line">                <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br><span class="line">                    logger.warn(<span class="string">"Exception encountered during context initialization - "</span> +</span><br><span class="line">                            <span class="string">"cancelling refresh attempt: "</span> + ex);</span><br><span class="line">                }</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 销毁所有的单例，以防止占用资源</span></span><br><span class="line">                destroyBeans();</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 重置激活状态</span></span><br><span class="line">                cancelRefresh(ex);</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 向上层抛出异常</span></span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            }</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">finally</span> {</span><br><span class="line">                <span class="comment">// 重置缓存，因为有些缓存数据在启动后就不再需要了</span></span><br><span class="line">                resetCommonCaches();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>下面会一个个地详细分析里面用到的方法。</p>
<h4 id="prepareRefresh"><a href="#prepareRefresh" class="headerlink" title="prepareRefresh()"></a><code>prepareRefresh()</code></h4><p>准备<em>Context</em>的刷新，主要设置一些启动时间、活跃标志以及初始化<em>PropertySouces</em>等。</p>
<p>这里还需要注意的是，关于<code>pre-refresh</code>的listeners和<em>early event</em>的处理。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// Switch to active.</span></span><br><span class="line">        <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">                logger.trace(<span class="string">"Refreshing "</span> + <span class="keyword">this</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                logger.debug(<span class="string">"Refreshing "</span> + getDisplayName());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Initialize any placeholder property sources in the context environment.</span></span><br><span class="line">        <span class="comment">// 空方法供子类实现</span></span><br><span class="line">        initPropertySources();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Validate that all properties marked as required are resolvable:</span></span><br><span class="line">        <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line">        <span class="comment">// 获取环境参数（Environment可能先于此创建），默认是StandardEnvironment</span></span><br><span class="line">        getEnvironment().validateRequiredProperties();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Store pre-refresh ApplicationListeners...</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 这里会保存pre-refresh状态下的listeners，即使此后再调用刷新，这些listeners会包含在所有的</span></span><br><span class="line">            <span class="comment">// listeners集合中。这么做的目的应该是用户在调用刷新前手动注册了一些liteners，而这些liteners</span></span><br><span class="line">            <span class="comment">// 并不是bean无法自动发现，这里只会设置一次值</span></span><br><span class="line">            <span class="keyword">this</span>.earlyApplicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.applicationListeners);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">            <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">            <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">        <span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line">        <span class="comment">// 同样，在multicaster没有准备好的情况下，先用一个集合来存放需要发布的事件。</span></span><br><span class="line">        <span class="comment">// 在publishEvent方法下，根据这个属性的值来判断multicaster是否已经准备就绪</span></span><br><span class="line">        <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="obtainFreshBeanFactory"><a href="#obtainFreshBeanFactory" class="headerlink" title="obtainFreshBeanFactory()"></a><code>obtainFreshBeanFactory()</code></h4><p>获取<code>ConfigurableListableBeanFactory</code>，主要的获取或者刷新方法供子类实现。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 抽象方法，子类实现。获取或刷新BeanFactory，待下文会分析`AbstractRefreshableApplicationContext`中的实现</span></span><br><span class="line">        refreshBeanFactory();</span><br><span class="line">        <span class="comment">// 获取上一步得到的`ConfigurableListableBeanFactory`，也是抽象方法，子类实现。</span></span><br><span class="line">        <span class="keyword">return</span> getBeanFactory();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="prepareBeanFactory"><a href="#prepareBeanFactory" class="headerlink" title="prepareBeanFactory()"></a><code>prepareBeanFactory()</code></h4><p>配置上一步获取的<code>BeanFactory</code>，为实例化bean做准备。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">        <span class="comment">// 设置与context有关的`ClassLoader`、`ExpressionParser`、`PropertyEditorRegistrar`</span></span><br><span class="line">        beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">        beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">        beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 这里注册了一个bean的后置处理器`ApplicationContextAwareProcessor`，其作用是为实现</span></span><br><span class="line">        <span class="comment">// `EnvironmentAware`、`EmbeddedValueResolverAware`、`ResourceLoaderAware`、</span></span><br><span class="line">        <span class="comment">// `ApplicationEventPublisherAware`、`MessageSourceAware`和`ApplicationContextAware`接口的</span></span><br><span class="line">        <span class="comment">// bean设置对应属性值，然后将这留个接口加入'ignoredDependencyInterfaces'，用于自动注入中忽略</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">        beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">        beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 注册可解决的依赖'resolvableDependencies'，有`BeanFactory`、`ResourceLoader`、`ApplicationEventPublisher`、`ApplicationContext`，这些都不做为bean存在，但是可以装配。</span></span><br><span class="line">        <span class="comment">// 注意，这里注册的`BeanFactory`是正在装备的'beanFactory'，而不是Context(this)</span></span><br><span class="line">        beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">        beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">        beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">        beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 注册bean后置处理器`ApplicationListenerDetector`</span></span><br><span class="line">        <span class="comment">// 其作用是在容器启动时注册listeners，在容器销毁时注销listeners</span></span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 如果包含有'loadTimeWeaver'，则注册`LoadTimeWeaverAwareProcessor`并设置'temporary ClassLoader'</span></span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {</span><br><span class="line">            beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">            <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">            beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 注册默认的环境变量beans</span></span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) {</span><br><span class="line">            beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) {</span><br><span class="line">            beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) {</span><br><span class="line">            beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="postProcessBeanFactory"><a href="#postProcessBeanFactory" class="headerlink" title="postProcessBeanFactory()"></a><code>postProcessBeanFactory()</code></h4><p>后置处理<code>BeanFactory</code>，可以看到这个方法是个空方法，是留给子类扩展的一个点。通过覆盖此方法可以修改<code>Context</code>内部的<code>BeanFactory</code>，此时<code>BeanFactory</code>已经初始化并且<strong>所有的<code>BeanDefinition</code>都已经加载</strong>（bean加载的动作是在<code>.obtainFreshBeanFactory()</code>方法中的<code>.refreshBeanFactory()</code>方法完成的，子类实现），<strong>但是还没有bean被实例化</strong>。此方法可用于注册一些特殊的<code>BeanPostProcessors</code>。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="invokeBeanFactoryPostProcessors"><a href="#invokeBeanFactoryPostProcessors" class="headerlink" title="invokeBeanFactoryPostProcessors()"></a><code>invokeBeanFactoryPostProcessors()</code></h4><p>见名知意，此方法用于调用已注册的<code>BeanFactoryPostProcessors</code>。</p>
<p><code>BeanFactoryPostProcessor</code>接口是Spring中很重要的一个扩展点，<em>ApplicationContext</em>将会在<em>bean definitions</em>自动检测<em>BeanFactoryPostProcessor</em>（也可通过<em>ConfigurableApplicationContext</em>编程注册），并且在其他<em>bean</em>创建前调用它们；它能够调整<em>context</em>下<em>bean factory</em>的属性配置，也能够修改<em>BeanDefinition</em>（这可能将导致bean的提前初始化）；可根据<code>PriorityOrdered</code>和<code>Ordered </code>排序（<code>@Order</code>无效），如果是编程注册，则按照注册的先后。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">        <span class="comment">// 委托给'PostProcessorRegistrationDelegate'调用'BeanFactoryPostProcessors'</span></span><br><span class="line">        PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 这里再一次检测BeanFactory是否包含有'loadTimeWeaver'，则进行织入准备。（'loadTimeWeaver'可能通过上面的处理方法注册了，所以需要重新检测一次）</span></span><br><span class="line">        <span class="keyword">if</span> (beanFactory.getTempClassLoader() == <span class="keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {</span><br><span class="line">            beanFactory.addBeanPostProcessor(<span class="keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">            beanFactory.setTempClassLoader(<span class="keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到，主要工作委托给了<code>PostProcessorRegistrationDelegate</code>（这里就不贴代码了，梳理一下主要逻辑）。其中的<code>invokeBeanFactoryPostProcessors</code>方法主要做了这些：</p>
<ul>
<li>如果<em>BeanFactory</em>是<code>BeanDefinitionRegistry</code>，则需要<strong>先调用<code>BeanDefinitionRegistryPostProcessors</code></strong><ul>
<li>首先是<em>ApplicationContext</em>中的（方法参数传入），调用顺序是注册的顺序</li>
<li>再是<em>BeanFactory</em>中的，调用顺序是先实现了<code>PriorityOrdered</code>的，再是<code>Ordered</code>的，最后是剩余的</li>
</ul>
</li>
<li>接下来调用<code>BeanFactoryPostProcessor</code><ul>
<li>首先调用上面<code>BeanDefinitionRegistryPostProcessors</code>类型的<code>BeanFactoryPostProcessor</code>，顺序也同上<strong>（如果<em>BeanFactory</em>是<code>BeanDefinitionRegistry</code>，不是的话没有这步）</strong></li>
<li>接着是<em>ApplicationContext</em>中的（方法参数传入），调用顺序是注册的顺序</li>
<li>再是<em>BeanFactory</em>中的，调用顺序是先实现了<code>PriorityOrdered</code>的，再是<code>Ordered</code>的，最后是剩余的</li>
</ul>
</li>
<li>清理<em>BeanFactory</em>的元数据缓存</li>
</ul>
<h4 id="registerBeanPostProcessors"><a href="#registerBeanPostProcessors" class="headerlink" title="registerBeanPostProcessors()"></a><code>registerBeanPostProcessors()</code></h4><p>调用完<code>BeanFactoryPostProcessors</code>后，接下来是注册<code>BeanPostProcessors</code>。同样，也是委托给类<code>PostProcessorRegistrationDelegate</code>。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">		PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="keyword">this</span>);</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

<p>具体过程也就不分析了，总体来说主要有这些逻辑步骤：</p>
<ul>
<li><code>BeanPostProcessors</code>的查找依赖于<code>ListableBeanFactory.getBeanNamesForType</code>接口</li>
<li>注册顺序：<em>PriorityOrdered</em>-&gt;<em>Ordered</em>-&gt;<em>rest</em>（<code>@Order</code>注解无用）</li>
<li>重新注册<em>internal BeanPostProcessors</em>，即<code>MergedBeanDefinitionPostProcessor</code></li>
<li>重新注册<code>ApplicationListenerDetector</code>（重新注册会加入到队列末尾）</li>
</ul>
<h4 id="initMessageSource"><a href="#initMessageSource" class="headerlink" title="initMessageSource()"></a><code>initMessageSource()</code></h4><p>初始化<code>MessageSource</code>。先查找有没有注册的<code>'messageSource'</code>的bean，若没有默认使用<code>DelegatingMessageSource</code>。</p>
<h4 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster()"></a><code>initApplicationEventMulticaster()</code></h4><p>这一步初始化<code>ApplicationEventMulticaster</code>。类似的套路，先查找有没有注册的，若没有则使用默认的<code>SimpleApplicationEventMulticaster</code>（在本文前面介绍<code>ApplicationEventPublisher</code>时有过描述）。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationEventMulticaster</span><span class="params">()</span> </span>{</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) {</span><br><span class="line">            <span class="keyword">this</span>.applicationEventMulticaster =</span><br><span class="line">                    beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">                logger.trace(<span class="string">"Using ApplicationEventMulticaster ["</span> + <span class="keyword">this</span>.applicationEventMulticaster + <span class="string">"]"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 若没有注册beanName为'applicationEventMulticaster'的bean，则默认使用`SimpleApplicationEventMulticaster`，然后将其注册为单例bean</span></span><br><span class="line">            <span class="keyword">this</span>.applicationEventMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">            beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="keyword">this</span>.applicationEventMulticaster);</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">                logger.trace(<span class="string">"No '"</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="string">"' bean, using "</span> +</span><br><span class="line">                        <span class="string">"["</span> + <span class="keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="string">"]"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh()"></a><code>onRefresh()</code></h4><p><code>onRefresh()</code>方法留给子类扩展的点，用于在实例化单例前初始化一些特殊的bean。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        <span class="comment">// For subclasses: do nothing by default.</span></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners()"></a><code>registerListeners()</code></h4><p>前面已经初始化了<code>applicationEventMulticaster</code>，这一步需要往其中注册<code>ApplicationListeners</code>，并且发布<em>early events</em>，清空<em>early events</em>。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 首先静态地注册那些特殊的'listeners'</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) {</span><br><span class="line">            getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 通过bean搜寻'listeners'并注册</span></span><br><span class="line">        <span class="comment">// 注意，这里并没有初始化`FactoryBean`，我们需要让所有常规的beans保持未初始化的状态以应用后置处理器</span></span><br><span class="line">        String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) {</span><br><span class="line">            getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 发布'early events'并清空</span></span><br><span class="line">        <span class="comment">// 到这里就和Context的publishEvent中的逻辑对应上了</span></span><br><span class="line">        Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">        <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) {</span><br><span class="line">                getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="finishBeanFactoryInitialization"><a href="#finishBeanFactoryInitialization" class="headerlink" title="finishBeanFactoryInitialization()"></a><code>finishBeanFactoryInitialization()</code></h4><p>到这里，<code>BeanFactory</code>已经准备就绪，接下来需要完成<code>BeanFactory</code>的初始化并且初始化剩余的单例bean(<em>non-lazy-init</em>的bean)。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>{</span><br><span class="line">        <span class="comment">// 为Context初始化‘conversionService’</span></span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">                beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) {</span><br><span class="line">            beanFactory.setConversionService(</span><br><span class="line">                    beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 如果没有，注册一个默认的'embedded value resolver'，主要处理@Value等的占位符。</span></span><br><span class="line">        <span class="comment">// 实现在类PropertyPlaceholderHelper.replacePlaceholders中</span></span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) {</span><br><span class="line">            beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span></span><br><span class="line">        String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) {</span><br><span class="line">            getBean(weaverAwareName);</span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">        <span class="comment">// 停止使用'tempClassLoader'</span></span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Allow for caching all bean definition metadata, not expecting further changes.</span></span><br><span class="line">        <span class="comment">// 冻结工厂配置</span></span><br><span class="line">        beanFactory.freezeConfiguration();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 实例化所有的非惰性的单例，其默认实现在'DefaultListableBeanFactory'，在前一篇关于'BeanFactory'的文章有讲述</span></span><br><span class="line">        beanFactory.preInstantiateSingletons();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="finishRefresh"><a href="#finishRefresh" class="headerlink" title="finishRefresh()"></a><code>finishRefresh()</code></h4><p>经过了漫长的分析，这里就是<code>Context</code>刷新的最后一步了，</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 清理resources缓存 (such as ASM metadata from scanning).</span></span><br><span class="line">        clearResourceCaches();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 初始化'lifecycleProcessor'，默认是`DefaultLifecycleProcessor`</span></span><br><span class="line">        initLifecycleProcessor();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 调用`LifecycleProcessor.onRefresh`方法，在上文中有简要叙述</span></span><br><span class="line">        getLifecycleProcessor().onRefresh();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 发布`ContextRefreshedEvent`事件</span></span><br><span class="line">        publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 将当前的Context的beans等信息做一个json格式的快照，并注册MBean</span></span><br><span class="line">        LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>到这里<code>refresh()</code>的分析就结束了。</p>
<h4 id="registerShutdownHook"><a href="#registerShutdownHook" class="headerlink" title="registerShutdownHook()"></a><code>registerShutdownHook()</code></h4><p>向<em>jvm</em>注册关闭钩子函数，其作用是使<code>Context</code>能在<em>jvm</em>关闭时实现优雅的关闭。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerShutdownHook</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.shutdownHook == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// No shutdown hook registered yet.</span></span><br><span class="line">            <span class="keyword">this</span>.shutdownHook = <span class="keyword">new</span> Thread(SHUTDOWN_HOOK_THREAD_NAME) {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                    <span class="keyword">synchronized</span> (startupShutdownMonitor) {</span><br><span class="line">                        <span class="comment">// 实际调用doClose方法</span></span><br><span class="line">                        doClose();</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">            Runtime.getRuntime().addShutdownHook(<span class="keyword">this</span>.shutdownHook);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>接下来看看<code>doClose()</code>的实现</p>
<h4 id="doClose"><a href="#doClose" class="headerlink" title="doClose()"></a><code>doClose()</code></h4><p>实际处理<code>Context</code>的关闭工作，或通过<em>shutdownHook</em>调用，或通过手动close调用。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 检查是否需要关闭</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.active.get() &amp;&amp; <span class="keyword">this</span>.closed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">                logger.debug(<span class="string">"Closing "</span> + <span class="keyword">this</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 移除MBean</span></span><br><span class="line">            LiveBeansView.unregisterApplicationContext(<span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 发布`ContextClosedEvent`事件</span></span><br><span class="line">                publishEvent(<span class="keyword">new</span> ContextClosedEvent(<span class="keyword">this</span>));</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">                logger.warn(<span class="string">"Exception thrown from ApplicationListener handling ContextClosedEvent"</span>, ex);</span><br><span class="line">            }</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// lifecycleProcessor.onClose，即调用Lifecycle beans的stop方法</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.lifecycleProcessor != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">this</span>.lifecycleProcessor.onClose();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">                    logger.warn(<span class="string">"Exception thrown from LifecycleProcessor on context close"</span>, ex);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 销毁beanFactory的所有缓存的单例</span></span><br><span class="line">            destroyBeans();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 关闭beanFactory，抽象方法，用于释放内部的beanFactory</span></span><br><span class="line">            closeBeanFactory();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 空方法，子类扩展</span></span><br><span class="line">            onClose();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 重置当前`ApplicationListeners`为'pre-refresh'状态</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">                <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">            }</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 切换状态到非激活态</span></span><br><span class="line">            <span class="keyword">this</span>.active.set(<span class="keyword">false</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p><code>AbstractApplicationContext</code>中还有需要子类实现的方法，主要用于<em>internal beanFactory</em>的定制和管理。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">closeBeanFactory</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="AbstractRefreshableApplicationContext"><a href="#AbstractRefreshableApplicationContext" class="headerlink" title="AbstractRefreshableApplicationContext"></a>AbstractRefreshableApplicationContext</h2><p><code>AbstractRefreshableApplicationContext</code>主要是实现了<code>AbstractApplicationContext</code>中定义的抽象方法。可多次调用<code>refresh()</code>方法，每一次内部都创建一个全新的<em>beanFactory</em>，其使用的工厂类是<code>DefaultListableBeanFactory</code>。</p>
<h3 id="refreshBeanFactory"><a href="#refreshBeanFactory" class="headerlink" title="refreshBeanFactory()"></a><code>refreshBeanFactory()</code></h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        <span class="keyword">if</span> (hasBeanFactory()) {</span><br><span class="line">            <span class="comment">// 若存在'beanFactory'，先销毁单例在关闭工厂</span></span><br><span class="line">            destroyBeans();</span><br><span class="line">            closeBeanFactory();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 创建一个新的`DefaultListableBeanFactory`</span></span><br><span class="line">            DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">            beanFactory.setSerializationId(getId());</span><br><span class="line">            <span class="comment">// 自定义工厂，主要是设置'allowBeanDefinitionOverriding'和'allowCircularReferences'</span></span><br><span class="line">            customizeBeanFactory(beanFactory);</span><br><span class="line">            <span class="comment">// 抽象方法，加载`BeanDefinitions`</span></span><br><span class="line">            loadBeanDefinitions(beanFactory);</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) {</span><br><span class="line">                <span class="comment">// 加锁设置'internal beanFactory'</span></span><br><span class="line">                <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="closeBeanFactory-和getBeanFactory"><a href="#closeBeanFactory-和getBeanFactory" class="headerlink" title="closeBeanFactory()和getBeanFactory"></a><code>closeBeanFactory()</code>和<code>getBeanFactory</code></h3><p>这两个方法实现都很简单，就是操作<code>refreshBeanFactory()</code>中获得的工厂。</p>
<h3 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h3><p>其定义了抽象模板方法<code>loadBeanDefinitions</code>供子类定制化实现bean定义的加载。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeansException, IOException</span>;</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="AbstractRefreshableConfigApplicationContext"><a href="#AbstractRefreshableConfigApplicationContext" class="headerlink" title="AbstractRefreshableConfigApplicationContext"></a>AbstractRefreshableConfigApplicationContext</h2><p>继承<code>AbstractRefreshableConfigApplicationContext</code>，实现了<code>BeanNameAware</code>和<code>InitializingBean</code>。能配置并解析<em>config locations</em>。</p>
<ul>
<li><code>setConfigLocations(locations)</code>  设置并解析<em>config locations</em>（会调用<code>resolvePath(String)</code>）</li>
<li><code>getConfigLocations()</code>  获取<em>config locations</em>，如果没有返回<code>getDefaultConfigLocations()</code>（默认返回null，子类可覆盖）</li>
<li><code>resolvePath(path)</code> 调用<code>getEnvironment().resolveRequiredPlaceholders(path)</code>来解析路径</li>
<li><code>setBeanName(name)</code> 如果没有设置过id，会把id设置成<em>beanName</em></li>
<li><code>afterPropertiesSet()</code> 如果在context构造后，如果context不是激活状态，则调用<code>refresh()</code></li>
</ul>
<h2 id="AbstractXmlApplicationContext"><a href="#AbstractXmlApplicationContext" class="headerlink" title="AbstractXmlApplicationContext"></a>AbstractXmlApplicationContext</h2><p>这里用来说明的是<em>xml</em>配置方式，注解方式也大同小异，就是委托的<code>BeanDefinitionReader</code>的不同。下面看<code>loadBeanDefinitions()</code>的实现。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>{</span><br><span class="line">        <span class="comment">// 为给定工厂，创建XmlBeanDefinitionReader，不同的配置方式使用不用的Reader</span></span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 给'beanDefinitionReader'配置Context的资源加载环境</span></span><br><span class="line">        beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">        beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</span><br><span class="line">        beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 允许子类提供'beanDefinitionReader'的自定义初始化，然后执行实际的`BeanDefinitions`的加载</span></span><br><span class="line">        initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">        loadBeanDefinitions(beanDefinitionReader);<span class="comment">// 下面</span></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException </span>{</span><br><span class="line">        <span class="comment">// 配置文件可以以`Resource`的形式存在</span></span><br><span class="line">        Resource[] configResources = getConfigResources();</span><br><span class="line">        <span class="keyword">if</span> (configResources != <span class="keyword">null</span>) {</span><br><span class="line">            reader.loadBeanDefinitions(configResources);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 或者以资源路径的形式存在</span></span><br><span class="line">        String[] configLocations = getConfigLocations();</span><br><span class="line">        <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) {</span><br><span class="line">            reader.loadBeanDefinitions(configLocations);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="ClassPathXmlApplicationContext"><a href="#ClassPathXmlApplicationContext" class="headerlink" title="ClassPathXmlApplicationContext"></a>ClassPathXmlApplicationContext</h2><p>到这一步，是用户可以直接使用的Context了。不同的构造函数代表不同的使用方式。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            String[] configLocations, <span class="keyword">boolean</span> refresh, <span class="meta">@Nullable</span> ApplicationContext parent)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        setConfigLocations(configLocations);</span><br><span class="line">        <span class="keyword">if</span> (refresh) {</span><br><span class="line">            refresh();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(String[] paths, Class&lt;?&gt; clazz, <span class="meta">@Nullable</span> ApplicationContext parent)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        Assert.notNull(paths, <span class="string">"Path array must not be null"</span>);</span><br><span class="line">        Assert.notNull(clazz, <span class="string">"Class argument must not be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.configResources = <span class="keyword">new</span> Resource[paths.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paths.length; i++) {</span><br><span class="line">            <span class="keyword">this</span>.configResources[i] = <span class="keyword">new</span> ClassPathResource(paths[i], clazz);</span><br><span class="line">        }</span><br><span class="line">        refresh();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Kidon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kidon.fun/2021/10/05/spring-ApplicationContext/">https://kidon.fun/2021/10/05/spring-ApplicationContext/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kidon.fun">啓東のblogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2022/03/07/study-in-springboot/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>springboot源码阅读——@SpringBootApplication</span></div></a></div><div class="next-post pull_right"><a href="/2021/10/04/spring-BeanFactory/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Spring源码学习—— BeanFactory</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/10/04/spring-BeanFactory/" title="Spring源码学习—— BeanFactory"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-10-04</div><div class="relatedPosts_title">Spring源码学习—— BeanFactory</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Kidon</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/canvas-nest.js"></script><script src="https://cdn.jsdelivr.net/npm/activate-power-mode/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = false;
POWERMODE.shake = true; 
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>