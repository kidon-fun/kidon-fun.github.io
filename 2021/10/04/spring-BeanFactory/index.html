<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Spring源码学习—— BeanFactory | 啓東のblogs</title><meta name="description" content="Spring源码学习—— BeanFactory"><meta name="keywords" content="spring"><meta name="author" content="Kidon"><meta name="copyright" content="Kidon"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon1.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring源码学习—— BeanFactory"><meta name="twitter:description" content="Spring源码学习—— BeanFactory"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Spring源码学习—— BeanFactory"><meta property="og:url" content="https://kidon.fun/2021/10/04/spring-BeanFactory/"><meta property="og:site_name" content="啓東のblogs"><meta property="og:description" content="Spring源码学习—— BeanFactory"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'true'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://kidon.fun/2021/10/04/spring-BeanFactory/"><link rel="prev" title="Spring源码学习—— ApplicationContext" href="https://kidon.fun/2021/10/05/spring-ApplicationContext/"><link rel="next" title="Nexus(Maven)仓库搭建和常见问题" href="https://kidon.fun/2020/03/30/nexus-repo/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://kidon.fun/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"top-right"},
  baiduPush: true,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 5.4.1"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">啓東のblogs</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">4</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw far fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AliasRegistry"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">AliasRegistry</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#SimpleAliasRegistry"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">SimpleAliasRegistry</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#SingletonBeanRegistry"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">SingletonBeanRegistry</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#DefaultSingletonBeanRegistry"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">DefaultSingletonBeanRegistry</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E5%B1%9E%E6%80%A7"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">属性</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%B8%89%E7%BA%A7%E5%AE%9E%E4%BE%8B%E7%BC%93%E5%AD%98%E5%AE%B9%E5%99%A8%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc_mobile_items-number">4.1.1.</span> <span class="toc_mobile_items-text">三级实例缓存容器（核心）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E6%A3%80%E6%B5%8B"><span class="toc_mobile_items-number">4.1.2.</span> <span class="toc_mobile_items-text">循环依赖检测</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#bean%E4%BE%9D%E8%B5%96"><span class="toc_mobile_items-number">4.1.3.</span> <span class="toc_mobile_items-text">bean依赖</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E7%89%B9%E6%80%A7"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">特性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95"><span class="toc_mobile_items-number">4.3.</span> <span class="toc_mobile_items-text">重要方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#getSingleton%E2%80%94%E2%80%94%E9%87%8D%E8%BD%BD%E4%B9%8B%E4%B8%80"><span class="toc_mobile_items-number">4.3.1.</span> <span class="toc_mobile_items-text">getSingleton——重载之一</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#getSingleton%E2%80%94%E2%80%94%E9%87%8D%E8%BD%BD%E4%B9%8B%E4%BA%8C"><span class="toc_mobile_items-number">4.3.2.</span> <span class="toc_mobile_items-text">getSingleton——重载之二</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#FactoryBeanRegistrySupport"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">FactoryBeanRegistrySupport</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E7%BC%93%E5%AD%98FactoryBean%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8D%95%E4%BE%8B"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">缓存FactoryBean创建的单例</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-1"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">重要方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#getObjectFromFactoryBean"><span class="toc_mobile_items-number">5.2.1.</span> <span class="toc_mobile_items-text">getObjectFromFactoryBean</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#BeanFactory"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">BeanFactory</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#bean%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%A1%BA%E5%BA%8F"><span class="toc_mobile_items-number">6.1.</span> <span class="toc_mobile_items-text">bean的初始化生命周期顺序</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#bean%E7%9A%84%E9%94%80%E6%AF%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%A1%BA%E5%BA%8F"><span class="toc_mobile_items-number">6.2.</span> <span class="toc_mobile_items-text">bean的销毁生命周期顺序</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#HierarchicalBeanFactory"><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">HierarchicalBeanFactory</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#ConfigurableBeanFactory"><span class="toc_mobile_items-number">8.</span> <span class="toc_mobile_items-text">ConfigurableBeanFactory</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AbstractBeanFactory"><span class="toc_mobile_items-number">9.</span> <span class="toc_mobile_items-text">AbstractBeanFactory</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E5%B1%9E%E6%80%A7-1"><span class="toc_mobile_items-number">9.1.</span> <span class="toc_mobile_items-text">属性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E7%89%B9%E6%80%A7-1"><span class="toc_mobile_items-number">9.2.</span> <span class="toc_mobile_items-text">特性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-2"><span class="toc_mobile_items-number">9.3.</span> <span class="toc_mobile_items-text">重要方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#getBean%EF%BC%88doGetBean%EF%BC%89"><span class="toc_mobile_items-number">9.3.1.</span> <span class="toc_mobile_items-text">getBean（doGetBean）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#getObjectForBeanInstance"><span class="toc_mobile_items-number">9.3.2.</span> <span class="toc_mobile_items-text">getObjectForBeanInstance</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AutowireCapableBeanFactory"><span class="toc_mobile_items-number">10.</span> <span class="toc_mobile_items-text">AutowireCapableBeanFactory</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E7%89%B9%E6%80%A7%EF%BC%9A"><span class="toc_mobile_items-number">10.1.</span> <span class="toc_mobile_items-text">特性：</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#AbstractAutowireCapableBeanFactory"><span class="toc_mobile_items-number">11.</span> <span class="toc_mobile_items-text">AbstractAutowireCapableBeanFactory</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E7%89%B9%E6%80%A7-2"><span class="toc_mobile_items-number">11.1.</span> <span class="toc_mobile_items-text">特性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-3"><span class="toc_mobile_items-number">11.2.</span> <span class="toc_mobile_items-text">重要方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#createBean"><span class="toc_mobile_items-number">11.2.1.</span> <span class="toc_mobile_items-text">createBean</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#doCreateBean"><span class="toc_mobile_items-number">11.2.2.</span> <span class="toc_mobile_items-text">doCreateBean</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#createBeanInstance"><span class="toc_mobile_items-number">11.2.3.</span> <span class="toc_mobile_items-text">createBeanInstance</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#getEarlyBeanReference"><span class="toc_mobile_items-number">11.2.4.</span> <span class="toc_mobile_items-text">getEarlyBeanReference</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#populateBean"><span class="toc_mobile_items-number">11.2.5.</span> <span class="toc_mobile_items-text">populateBean</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#initializeBean"><span class="toc_mobile_items-number">11.2.6.</span> <span class="toc_mobile_items-text">initializeBean</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#ListableBeanFactory"><span class="toc_mobile_items-number">12.</span> <span class="toc_mobile_items-text">ListableBeanFactory</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E7%89%B9%E6%80%A7-3"><span class="toc_mobile_items-number">12.1.</span> <span class="toc_mobile_items-text">特性</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#ConfigurableListableBeanFactory"><span class="toc_mobile_items-number">13.</span> <span class="toc_mobile_items-text">ConfigurableListableBeanFactory</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#BeanDefinitionRegistry"><span class="toc_mobile_items-number">14.</span> <span class="toc_mobile_items-text">BeanDefinitionRegistry</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#DefaultListableBeanFactory"><span class="toc_mobile_items-number">15.</span> <span class="toc_mobile_items-text">DefaultListableBeanFactory</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E7%89%B9%E6%80%A7-4"><span class="toc_mobile_items-number">15.1.</span> <span class="toc_mobile_items-text">特性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-4"><span class="toc_mobile_items-number">15.2.</span> <span class="toc_mobile_items-text">重要方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#resolveBean"><span class="toc_mobile_items-number">15.2.1.</span> <span class="toc_mobile_items-text">resolveBean</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#resolveNamedBean"><span class="toc_mobile_items-number">15.2.2.</span> <span class="toc_mobile_items-text">resolveNamedBean</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#preInstantiateSingletons"><span class="toc_mobile_items-number">15.2.3.</span> <span class="toc_mobile_items-text">preInstantiateSingletons</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AliasRegistry"><span class="toc-number">1.</span> <span class="toc-text">AliasRegistry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SimpleAliasRegistry"><span class="toc-number">2.</span> <span class="toc-text">SimpleAliasRegistry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SingletonBeanRegistry"><span class="toc-number">3.</span> <span class="toc-text">SingletonBeanRegistry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultSingletonBeanRegistry"><span class="toc-number">4.</span> <span class="toc-text">DefaultSingletonBeanRegistry</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7"><span class="toc-number">4.1.</span> <span class="toc-text">属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%BA%A7%E5%AE%9E%E4%BE%8B%E7%BC%93%E5%AD%98%E5%AE%B9%E5%99%A8%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-number">4.1.1.</span> <span class="toc-text">三级实例缓存容器（核心）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E6%A3%80%E6%B5%8B"><span class="toc-number">4.1.2.</span> <span class="toc-text">循环依赖检测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bean%E4%BE%9D%E8%B5%96"><span class="toc-number">4.1.3.</span> <span class="toc-text">bean依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95"><span class="toc-number">4.3.</span> <span class="toc-text">重要方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getSingleton%E2%80%94%E2%80%94%E9%87%8D%E8%BD%BD%E4%B9%8B%E4%B8%80"><span class="toc-number">4.3.1.</span> <span class="toc-text">getSingleton——重载之一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getSingleton%E2%80%94%E2%80%94%E9%87%8D%E8%BD%BD%E4%B9%8B%E4%BA%8C"><span class="toc-number">4.3.2.</span> <span class="toc-text">getSingleton——重载之二</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FactoryBeanRegistrySupport"><span class="toc-number">5.</span> <span class="toc-text">FactoryBeanRegistrySupport</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98FactoryBean%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8D%95%E4%BE%8B"><span class="toc-number">5.1.</span> <span class="toc-text">缓存FactoryBean创建的单例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-1"><span class="toc-number">5.2.</span> <span class="toc-text">重要方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getObjectFromFactoryBean"><span class="toc-number">5.2.1.</span> <span class="toc-text">getObjectFromFactoryBean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanFactory"><span class="toc-number">6.</span> <span class="toc-text">BeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bean%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%A1%BA%E5%BA%8F"><span class="toc-number">6.1.</span> <span class="toc-text">bean的初始化生命周期顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bean%E7%9A%84%E9%94%80%E6%AF%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%A1%BA%E5%BA%8F"><span class="toc-number">6.2.</span> <span class="toc-text">bean的销毁生命周期顺序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HierarchicalBeanFactory"><span class="toc-number">7.</span> <span class="toc-text">HierarchicalBeanFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigurableBeanFactory"><span class="toc-number">8.</span> <span class="toc-text">ConfigurableBeanFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractBeanFactory"><span class="toc-number">9.</span> <span class="toc-text">AbstractBeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7-1"><span class="toc-number">9.1.</span> <span class="toc-text">属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7-1"><span class="toc-number">9.2.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-2"><span class="toc-number">9.3.</span> <span class="toc-text">重要方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getBean%EF%BC%88doGetBean%EF%BC%89"><span class="toc-number">9.3.1.</span> <span class="toc-text">getBean（doGetBean）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getObjectForBeanInstance"><span class="toc-number">9.3.2.</span> <span class="toc-text">getObjectForBeanInstance</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AutowireCapableBeanFactory"><span class="toc-number">10.</span> <span class="toc-text">AutowireCapableBeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%EF%BC%9A"><span class="toc-number">10.1.</span> <span class="toc-text">特性：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AbstractAutowireCapableBeanFactory"><span class="toc-number">11.</span> <span class="toc-text">AbstractAutowireCapableBeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7-2"><span class="toc-number">11.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-3"><span class="toc-number">11.2.</span> <span class="toc-text">重要方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createBean"><span class="toc-number">11.2.1.</span> <span class="toc-text">createBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#doCreateBean"><span class="toc-number">11.2.2.</span> <span class="toc-text">doCreateBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createBeanInstance"><span class="toc-number">11.2.3.</span> <span class="toc-text">createBeanInstance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getEarlyBeanReference"><span class="toc-number">11.2.4.</span> <span class="toc-text">getEarlyBeanReference</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#populateBean"><span class="toc-number">11.2.5.</span> <span class="toc-text">populateBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#initializeBean"><span class="toc-number">11.2.6.</span> <span class="toc-text">initializeBean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListableBeanFactory"><span class="toc-number">12.</span> <span class="toc-text">ListableBeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7-3"><span class="toc-number">12.1.</span> <span class="toc-text">特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigurableListableBeanFactory"><span class="toc-number">13.</span> <span class="toc-text">ConfigurableListableBeanFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanDefinitionRegistry"><span class="toc-number">14.</span> <span class="toc-text">BeanDefinitionRegistry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultListableBeanFactory"><span class="toc-number">15.</span> <span class="toc-text">DefaultListableBeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7-4"><span class="toc-number">15.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95-4"><span class="toc-number">15.2.</span> <span class="toc-text">重要方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#resolveBean"><span class="toc-number">15.2.1.</span> <span class="toc-text">resolveBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#resolveNamedBean"><span class="toc-number">15.2.2.</span> <span class="toc-text">resolveNamedBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#preInstantiateSingletons"><span class="toc-number">15.2.3.</span> <span class="toc-text">preInstantiateSingletons</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Spring源码学习—— BeanFactory</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2021-10-04<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2021-10-04</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head><script src="\assets\js\APlayer.min.js"> </script></head><body><p><code>BeanFactory</code>是Spring框架的核心接口之一，它是bean的容器。类结构图如下（以<code>XmlBeanFactory</code>为例）。</p>
<p>![image-20210902162721587](/Users/mac/Library/Application Support/typora-user-images/image-20210902162721587.png)</p>
<p>我们将按照继承关系，从上到下一个个的梳理这些不同类和接口的关系。</p>
<hr>
<h2 id="AliasRegistry"><a href="#AliasRegistry" class="headerlink" title="AliasRegistry"></a><code>AliasRegistry</code></h2><p>我们知道在spring中是可以给bean定义一个或多个别名的。而<code>AliasRegistry</code>就是管理别名的通用接口，它定义了给bean**<u>注册、移除、判断、获取</u>**别名的能力。后文我们可以看见其主要是为<code>BeanDefinitionRegistry</code>服务。</p>
<hr>
<h2 id="SimpleAliasRegistry"><a href="#SimpleAliasRegistry" class="headerlink" title="SimpleAliasRegistry"></a><code>SimpleAliasRegistry</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">AliasRegistry</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>AliasRegistry</code>的简单实现类，它有着如下特性：</p>
<ol>
<li>使用<code>ConcurrentHashMap</code>作为储存alias和beanName之间的映射关系，”alias-&gt;canonical name”。</li>
<li>方法<code>cannonicalName(String)</code>返回bean的本名</li>
<li>修改操作统一加锁（锁为map容器）</li>
<li>方法<code>allowAliasOverriding()</code>决定是否允许别名覆盖，依赖子类的<code>allowBeanDefinitionOverriding</code>属性</li>
<li>别名不允许循环，即不能有<code>A-&gt;B</code>且<code>B-&gt;C</code>且<code>C-&gt;A</code></li>
<li>如果有<code>A-&gt;A</code>，那么会将别名<code>A</code>从容器里删除</li>
<li>可使用<code>StringValueResolver</code>来处理别名和注册名字符串(no usage)</li>
</ol>
<hr>
<h2 id="SingletonBeanRegistry"><a href="#SingletonBeanRegistry" class="headerlink" title="SingletonBeanRegistry"></a><code>SingletonBeanRegistry</code></h2><p>顶层接口，管理单例bean。定义了注册、获取、判断单例bean以及获取容器锁的方法。<strong>注意，这被注册到里面的bean应该是<u>完全初始化</u>的，不应该执行回调函数（比如生命周期函数）。如果需要执行回调，应该使用BeanFactory注册BeanDefinition。</strong></p>
<hr>
<h2 id="DefaultSingletonBeanRegistry"><a href="#DefaultSingletonBeanRegistry" class="headerlink" title="DefaultSingletonBeanRegistry"></a><code>DefaultSingletonBeanRegistry</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>SingletonBeanRegistry</code>的默认实现。管理着单例bean的注册、获取等；三级实例缓存；单例循环依赖检测；依赖检查等。</p>
<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><h4 id="三级实例缓存容器（核心）"><a href="#三级实例缓存容器（核心）" class="headerlink" title="三级实例缓存容器（核心）"></a>三级实例缓存容器（核心）</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 缓存fully initialized的单例 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"><span class="comment">/** 缓存ObjectFactory */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"><span class="comment">/** 缓存early instance*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<p>这三个map构成了spring加载单例的基础。<u>通过*<code>singletonFactories</code><em>提前暴露bean的<code>ObjectFactory</code>并使用</em><code>earlySingletonObjects</code><em>缓存</em>early instance*，可以解决<strong>属性注入</strong>的循环依赖问题。</u></p>
<h4 id="循环依赖检测"><a href="#循环依赖检测" class="headerlink" title="循环依赖检测"></a>循环依赖检测</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 标记现在正在创建中的bean name */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; singletonsCurrentlyInCreation = Collections.newSetFromMap(<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>));</span><br><span class="line"><span class="comment">/** 创建中不需要检查的bean name */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; inCreationCheckExclusions = Collections.newSetFromMap(<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>));</span><br></pre></td></tr></tbody></table></figure></div>

<p>这两个set用来控制创建中的bean的检查。<u><strong>注意，一般来说，通过它们能够检测到循环依赖，而解决属性注入的循环依赖问题的是暴露创建bean的<code>ObjectFactory</code>，即上面的*<code>singletonFactories</code>*。</strong></u></p>
<h4 id="bean依赖"><a href="#bean依赖" class="headerlink" title="bean依赖"></a>bean依赖</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** outer bean -&gt; inner bean （外层依赖内层）*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; containedBeanMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"><span class="comment">/** depended bean -&gt; dependent bean (谁依赖我)*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; dependentBeanMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br><span class="line"><span class="comment">/** dependent bean -&gt; depended bean (我依赖谁) */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; dependenciesForBeanMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<p>依赖的关系有传递性，即<code>A-&gt;B</code>，<code>B-&gt;C</code>，则<code>A-&gt;C</code>。</p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li>修改三个缓存map需要加锁同步</li>
<li>能够直接注册单例</li>
<li>查找单例bean的顺序其一：*<code>singletonObjects</code><em>-&gt;</em><code>earlySingletonObjects</code><em>-&gt;</em><code>singletonFactories</code>*，反过来就是实例的流转顺序。</li>
<li>查找单例bean的顺序其二：*<code>singletonObjects</code>*-&gt;<em>ObjectFactory&lt;?&gt;</em></li>
<li>销毁单例bean的顺序：先消除依赖我的bean，再消除自身</li>
</ul>
<h3 id="重要方法"><a href="#重要方法" class="headerlink" title="重要方法"></a>重要方法</h3><h4 id="getSingleton——重载之一"><a href="#getSingleton——重载之一" class="headerlink" title="getSingleton——重载之一"></a>getSingleton——重载之一</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>{</span><br><span class="line">    <span class="comment">// 先从singletonObjects中寻找</span></span><br><span class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) {</span><br><span class="line">            <span class="comment">// 如果是正在创建，则在earlySingletonObjects中寻找</span></span><br><span class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) {</span><br><span class="line">                <span class="comment">// 若还未找到且允许提前初始化，则在singletonFactories中寻找bean的构造工厂</span></span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="comment">// 若找到构造工厂，则创建bean并且放入earlySingletonObjects</span></span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 返回的单例可能是完全初始化的，或者是未完全初始化的</span></span><br><span class="line">    <span class="keyword">return</span> singletonObject;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这个方法主要就是检查缓存，并且在某些条件下将使用<code>ObjectFactory.getObject()</code>创建bean并移入*<code>earlySingltonObjects</code>*。</p>
<p><strong>这里留个疑问，<code>ObjectFactory</code>是何时放入<code>singletonFactories</code>中的？</strong>这个在下文会有叙述。</p>
<h4 id="getSingleton——重载之二"><a href="#getSingleton——重载之二" class="headerlink" title="getSingleton——重载之二"></a>getSingleton——重载之二</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>{</span><br><span class="line">        Assert.notNull(beanName, <span class="string">"Bean name must not be null"</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) {</span><br><span class="line">            Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) { <span class="comment">// 缓存中不存在</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.singletonsCurrentlyInDestruction) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationNotAllowedException(beanName,</span><br><span class="line">                            <span class="string">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> +</span><br><span class="line">                            <span class="string">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">                    logger.debug(<span class="string">"Creating shared instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 标记bean正在创建，并检查</span></span><br><span class="line">                beforeSingletonCreation(beanName);</span><br><span class="line">                <span class="keyword">boolean</span> newSingleton = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> recordSuppressedExceptions = (<span class="keyword">this</span>.suppressedExceptions == <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (recordSuppressedExceptions) {</span><br><span class="line">                    <span class="keyword">this</span>.suppressedExceptions = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 使用`ObjectFactory`构建singleton</span></span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    newSingleton = <span class="keyword">true</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">catch</span> (IllegalStateException ex) {</span><br><span class="line">                    <span class="comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span></span><br><span class="line">                    <span class="comment">// if yes, proceed with it since the exception indicates that state.</span></span><br><span class="line">                    singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) {</span><br><span class="line">                        <span class="keyword">throw</span> ex;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">catch</span> (BeanCreationException ex) {</span><br><span class="line">                    <span class="keyword">if</span> (recordSuppressedExceptions) {</span><br><span class="line">                        <span class="keyword">for</span> (Exception suppressedException : <span class="keyword">this</span>.suppressedExceptions) {</span><br><span class="line">                            ex.addRelatedCause(suppressedException);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">finally</span> {</span><br><span class="line">                    <span class="keyword">if</span> (recordSuppressedExceptions) {</span><br><span class="line">                        <span class="keyword">this</span>.suppressedExceptions = <span class="keyword">null</span>;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">// 移除bean正在创建标志，并检查</span></span><br><span class="line">                    afterSingletonCreation(beanName);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (newSingleton) {</span><br><span class="line">                    <span class="comment">// 将创建好的bean，加入singleton缓存</span></span><br><span class="line">                    addSingleton(beanName, singletonObject);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> singletonObject;</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>这个方法虽然看起来很长，但是多数是异常处理和执行核心逻辑前后的检查操作。其主要工作就是通过<code>ObjectFactory</code>创建bean并放入单例缓存中。</p>
<hr>
<h2 id="FactoryBeanRegistrySupport"><a href="#FactoryBeanRegistrySupport" class="headerlink" title="FactoryBeanRegistrySupport"></a><code>FactoryBeanRegistrySupport</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryBeanRegistrySupport</span> <span class="keyword">extends</span> <span class="title">DefaultSingletonBeanRegistry</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p>在<code>DefaultSingletonBeanRegistry</code>的基础上，增加了对于<code>FactoryBean</code>的支持。</p>
<h3 id="缓存FactoryBean创建的单例"><a href="#缓存FactoryBean创建的单例" class="headerlink" title="缓存FactoryBean创建的单例"></a>缓存FactoryBean创建的单例</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** FactoryBean name -&gt; object */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; factoryBeanObjectCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<p>**<u>这里缓存的是<code>FactoryBean</code>创建的对象，而<code>FactoryBean</code>本身则作为一个单例bean储存在<code>singletonObjects</code>中。</u>**需要注意的是，这里只会缓存单例<code>FactoryBean</code>并且其创建的bean也是单例的。</p>
<h3 id="重要方法-1"><a href="#重要方法-1" class="headerlink" title="重要方法"></a>重要方法</h3><h4 id="getObjectFromFactoryBean"><a href="#getObjectFromFactoryBean" class="headerlink" title="getObjectFromFactoryBean"></a>getObjectFromFactoryBean</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectFromFactoryBean</span><span class="params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="keyword">boolean</span> shouldPostProcess)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) {</span><br><span class="line">          	<span class="comment">// 如果是单例bean，并且singletonObjects中含有该FactoryBean</span></span><br><span class="line">            <span class="keyword">synchronized</span> (getSingletonMutex()) {</span><br><span class="line">                <span class="comment">// 先尝试从缓存factoryBeanObjectCache中获取</span></span><br><span class="line">                Object object = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (object == <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="comment">// 缓存中没有，则通过Factory.getObject()获取；若是null，则会返回NullBean</span></span><br><span class="line">                    object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">                    <span class="comment">// 在上面的getObject()调用期间，bean可能通过其他方式加入了缓存，故需要再次检查</span></span><br><span class="line">                  	<span class="comment">// 这么做的目的是，保证单例bean的后置处理只应用一次</span></span><br><span class="line">                    Object alreadyThere = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (alreadyThere != <span class="keyword">null</span>) {</span><br><span class="line">                        object = alreadyThere;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> {</span><br><span class="line">                        <span class="keyword">if</span> (shouldPostProcess) {</span><br><span class="line">                            <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) {</span><br><span class="line">                                <span class="comment">// 正在创建中，临时返回对象（未后置处理和储存）</span></span><br><span class="line">                                <span class="keyword">return</span> object;</span><br><span class="line">                            }</span><br><span class="line">                            <span class="comment">// 标记正在创建</span></span><br><span class="line">                            beforeSingletonCreation(beanName);</span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                <span class="comment">// FactoryBean创建的bean后置处理，比如aop代理等</span></span><br><span class="line">                                object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">                            }</span><br><span class="line">                            <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</span><br><span class="line">                                        <span class="string">"Post-processing of FactoryBean's singleton object failed"</span>, ex);</span><br><span class="line">                            }</span><br><span class="line">                            <span class="keyword">finally</span> {</span><br><span class="line">                                <span class="comment">// 移除正在创建标记</span></span><br><span class="line">                                afterSingletonCreation(beanName);</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">if</span> (containsSingleton(beanName)) {</span><br><span class="line">                            <span class="comment">// 加入缓存</span></span><br><span class="line">                            <span class="keyword">this</span>.factoryBeanObjectCache.put(beanName, object);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 如果实例本身或者FactoryBean不是单例，则每次获取都要调用Factory.getObject()，并且应用后置处理</span></span><br><span class="line">            Object object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">            <span class="keyword">if</span> (shouldPostProcess) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                  	<span class="comment">// 后置处理</span></span><br><span class="line">                    object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName, <span class="string">"Post-processing of FactoryBean's object failed"</span>, ex);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>总体上看，就是先区分是否是单例。若是单例，则通过<code>FactoryBean</code>获取单例，并应用后置处理，需要注意的是单例bean 后置处理只能应用一次，之后加入缓存，下一次获取则通过缓存。若不是单例，则每次都通过<code>FactoryBean</code>获取，并应用后置处理。</p>
<hr>
<h2 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a><code>BeanFactory</code></h2><p><code>BeanFactory</code>接口是整个<em>bean factory</em>体系的顶层接口，也是我们属性的“spring容器”，它管理着所有的bean。<strong>说一个bean存在于<code>BeanFactory</code>，它可能是bean definition或singleton实例，也可能存在于当前工厂或者是父工厂。</strong>它还要求实现类应该要满足下面的bean生命周期。</p>
<h3 id="bean的初始化生命周期顺序"><a href="#bean的初始化生命周期顺序" class="headerlink" title="bean的初始化生命周期顺序"></a>bean的初始化生命周期顺序</h3><ol>
<li><code>BeanNameAware.setBeanName(String)</code></li>
<li><code>BeanClassLoaderAware.setBeanClassLoader(ClassLoader)</code></li>
<li><code>BeanFactoryAware.setBeanFactory(BeanFactory)</code></li>
<li><code>EnvironmentAware.setEnvironment(Environment)</code></li>
<li><code>EmbeddedValueResolverAware.setEmbeddedValueResolver(StringValueResolver)</code></li>
<li>*<code>ResourceLoaderAware.setResourceLoader(ResourceLoader)</code></li>
<li>*<code>ApplicationEventPublisherAware.setApplicationEventPublisher(ApplicationEventPublisher)</code></li>
<li>*<code>MessageSourceAware.setMessageSource(MessageSource)</code></li>
<li>*<code>ApplicationContextAware.setApplicationContext(ApplicationContext)</code></li>
<li>**<code>ServletContextAware.setServletContext(ServletContext)</code></li>
<li><code>BeanPostProcessor.postProcessBeforeInitialization(Object, String)</code>（<code>@PostConstruct</code>在其中）</li>
<li><code>InitializingBean.afterPropertiesSet()</code></li>
<li><em>a custom init-method definition</em></li>
<li><code>BeanPostProcessor.postProcessAfterInitialization(Object, String)</code></li>
</ol>
<h3 id="bean的销毁生命周期顺序"><a href="#bean的销毁生命周期顺序" class="headerlink" title="bean的销毁生命周期顺序"></a>bean的销毁生命周期顺序</h3><ol>
<li><code>DestructionAwareBeanPostProcessor.postProcessBeforeDestruction(Object, String)</code>(<code>@PreDestroy</code>在其中)</li>
<li><code>DisposableBean.destroy()</code></li>
<li><em>a custom destroy-method definition</em></li>
</ol>
<hr>
<h2 id="HierarchicalBeanFactory"><a href="#HierarchicalBeanFactory" class="headerlink" title="HierarchicalBeanFactory"></a><code>HierarchicalBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HierarchicalBeanFactory</span> <span class="keyword">extends</span> <span class="title">BeanFactory</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>HierarchicalBeanFactory</code>在<code>BeanFactory</code>的基础上引入了容器继承体系。</p>
<hr>
<h2 id="ConfigurableBeanFactory"><a href="#ConfigurableBeanFactory" class="headerlink" title="ConfigurableBeanFactory"></a><code>ConfigurableBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableBeanFactory</span> <span class="keyword">extends</span> <span class="title">HierarchicalBeanFactory</span>, <span class="title">SingletonBeanRegistry</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>ConfigurableBeanFactory</code>提供了一系列配置bean容器的接口，主要由spring框架自身使用。它有如下功能：</p>
<ol>
<li>设置<em>parentBeanFactory</em>，只能设置一次，而且尽可能使用构造器初始化</li>
<li>设置<em>beanClassLoader</em></li>
<li>设置<em>tempClassLoader</em>，用于类型匹配，通常只在<em>weaving</em>使用，一旦<code>BeanFactory</code>完成启动阶段就会被删除</li>
<li>设置<em>cacheBeanMetadata</em>，是否缓存<em>bean</em>的元数据，如<em>bean definitions</em>和<em>resolved bean classes</em>，默认开启</li>
<li>设置<code>BeanExpressionResolver</code>，如<code>"#{...}"</code>解析器</li>
<li>设置<code>ConversionService</code></li>
<li>添加<code>PropertyEditorRegistrar</code>，用于所有bean的创建过程</li>
<li>注册<em>customerEditor</em>（<code>PropertyEditor</code>）</li>
<li>设置<code>TypeConverter</code>，用于转化bean的属性值类型、构造参数类型等</li>
<li>添加<em>embeddedValueResolver</em>（<code>StringValueResolver</code>）</li>
<li>添加<code>BeanPostProcessor</code>，<strong>调用顺序和加入顺序相同，忽略<code>Ordered</code>接口，手动添加的先于自动发现的</strong></li>
<li>注册<code>Scope</code></li>
<li>复制配置</li>
<li>注册、解析别名</li>
<li>获取<em>mergedBeanDefinition</em></li>
<li>判断是否是<code>FactoryBean</code></li>
<li>标记正在创建中的bean</li>
<li>注册依赖的bean</li>
<li>销毁指定bean</li>
<li>销毁所有单例</li>
</ol>
<hr>
<h2 id="AbstractBeanFactory"><a href="#AbstractBeanFactory" class="headerlink" title="AbstractBeanFactory"></a><code>AbstractBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">extends</span> <span class="title">FactoryBeanRegistrySupport</span> <span class="keyword">implements</span> <span class="title">ConfigurableBeanFactory</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>AbstractBeanFactory</code>提供了<code>ConfigurableBeanFactory</code>接口定义的能力。提供单例bean缓存、singleton/prototype类型判定、<code>FactoryBean</code>处理、别名、bean定义合并、bean销毁、父子容器等。提供给子类实现的主要模板方法是<code>getBeanDefinition()</code>和<code>createBean()</code>。</p>
<h3 id="属性-1"><a href="#属性-1" class="headerlink" title="属性"></a>属性</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span> <span class="comment">/** 父bean工厂 */</span></span><br><span class="line"><span class="keyword">private</span> BeanFactory parentBeanFactory;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span> <span class="comment">/** bean的类加载器  */</span></span><br><span class="line"><span class="keyword">private</span> ClassLoader beanClassLoader = ClassUtils.getDefaultClassLoader();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span> <span class="comment">/** 临时类加载器，用于在必要的时候解析bean class name */</span></span><br><span class="line"><span class="keyword">private</span> ClassLoader tempClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 是否缓存bean的元数据，而不是每次都重新获取 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> cacheBeanMetadata = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span> <span class="comment">/** bean定义中值的表达式解析策略 */</span></span><br><span class="line"><span class="keyword">private</span> BeanExpressionResolver beanExpressionResolver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span> <span class="comment">/** Spring的ConversionService，用于替代PropertyEditors. */</span></span><br><span class="line"><span class="keyword">private</span> ConversionService conversionService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 自定义的PropertyEditorRegistrars，用于应用于这个bean工厂中的bean */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;PropertyEditorRegistrar&gt; propertyEditorRegistrars = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 自定义的PropertyEditors，用于应用于这个bean工厂中的bean */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Class&lt;? extends PropertyEditor&gt;&gt; customEditors = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span> <span class="comment">/** 自定义的TypeConverter，用于覆盖默认的PropertyEditor机制 */</span></span><br><span class="line"><span class="keyword">private</span> TypeConverter typeConverter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** StringValueResolver用于解析<span class="doctag">@Value</span>("xxx")等 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;StringValueResolver&gt; embeddedValueResolvers = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** bean后置处理器 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;BeanPostProcessor&gt; beanPostProcessors = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 标记是否有InstantiationAwareBeanPostProcessors被注册 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasInstantiationAwareBeanPostProcessors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 标记是否有DestructionAwareBeanPostProcessors被注册 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasDestructionAwareBeanPostProcessors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 注册的scope */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Scope&gt; scopes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span> <span class="comment">/** Security context used when running with a SecurityManager. */</span></span><br><span class="line"><span class="keyword">private</span> SecurityContextProvider securityContextProvider;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** bean名称 -&gt; 合并的bean定义 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RootBeanDefinition&gt; mergedBeanDefinitions = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 至少创建过一次的bean名称集合 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; alreadyCreated = Collections.newSetFromMap(<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 当前线程正在创建的bean名称 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Prototype beans currently in creation"</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到其中的属性大多是为了实现<code>ConfigurableBeanFactory</code>中定义的功能而使用的。</p>
<h3 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a>特性</h3><ol>
<li>完全提供了<code>ConfigurableBeanFactory</code>规定的能力</li>
<li><code>doGetBean()</code>为核心方法，处理了普通bean和<code>FactoryBean</code>，分析见下文</li>
<li><code>createBean()</code>和<code>getBeanDefinition()</code>为模板方法，供子类实现</li>
<li>如果bean存在于工厂中，是指存在当前工厂或父工厂，其形态可能是bean定义也可能是单例bean</li>
<li>一个bean是单例，指的是它本身是单例的，如果它是通过<code>FactoryBean</code>构建的，那么<code>FactoryBean.isSingleton()</code>应该返回单例</li>
<li><code>isTypeMatch()</code>较为复杂，需要考虑所有可能的情况</li>
<li><code>BeanPostProcessor</code>按照添加的顺序调用，忽略<code>Ordered</code>接口</li>
<li><code>containsBean()</code>考虑父工厂，而<code>containsBeanDefinition()</code>只考虑当前工厂。</li>
</ol>
<h3 id="重要方法-2"><a href="#重要方法-2" class="headerlink" title="重要方法"></a>重要方法</h3><h4 id="getBean（doGetBean）"><a href="#getBean（doGetBean）" class="headerlink" title="getBean（doGetBean）"></a>getBean（doGetBean）</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="keyword">return</span> doGetBean(name, requiredType, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, <span class="meta">@Nullable</span> <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Nullable</span> <span class="keyword">final</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">    <span class="comment">// 转换名称：FactoryBean去除'&amp;'，别名转化成本名</span></span><br><span class="line">    <span class="keyword">final</span> String beanName = transformedBeanName(name);</span><br><span class="line">    Object bean;</span><br><span class="line">    <span class="comment">// 先在三级缓存中寻找</span></span><br><span class="line">    Object sharedInstance = getSingleton(beanName);</span><br><span class="line">    <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">            <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) {</span><br><span class="line">                logger.trace(<span class="string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +</span><br><span class="line">                        <span class="string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                logger.trace(<span class="string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 如果三级缓存中已经存在且没有指定构造参数，则从sharedInstance中获取bean，此方法见后文</span></span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 一般来说第一次创建会走下面的else</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 检测prototype类型的bean是否存在循环依赖</span></span><br><span class="line">        <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">        }</span><br><span class="line">  </span><br><span class="line">        BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">        <span class="comment">// 注意这里的条件判断的后半部分</span></span><br><span class="line">        <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) {</span><br><span class="line">            <span class="comment">// 走到此，如果当前factory不存在bean定义，且父类工厂不为空，则在父工厂中寻找</span></span><br><span class="line">            <span class="comment">// 根据条件调用不同版本的getBean()方法</span></span><br><span class="line">            String nameToLookup = originalBeanName(name);</span><br><span class="line">            <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) {</span><br><span class="line">                <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">                        nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (requiredType != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (!typeCheckOnly) {</span><br><span class="line">            <span class="comment">// 如果获取bean的目的是实际使用而不仅是类型检查，标记此bean为已创建的</span></span><br><span class="line">            markBeanAsCreated(beanName);</span><br><span class="line">        }</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 获取合并的bean定义，将BeanDefinition转为RootBeanDefinition</span></span><br><span class="line">            <span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">            checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 获取depends-on属性上的值，并保证被依赖的bean先初始化</span></span><br><span class="line">            <span class="comment">// 注意，这里是depends-on属性上的配置值，不是bean的依赖（比如autowired等）</span></span><br><span class="line">            String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">            <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">for</span> (String dep : dependsOn) {</span><br><span class="line">                    <span class="keyword">if</span> (isDependent(beanName, dep)) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                <span class="string">"Circular depends-on relationship between '"</span> + beanName + <span class="string">"' and '"</span> + dep + <span class="string">"'"</span>);</span><br><span class="line">                    }</span><br><span class="line">                    registerDependentBean(dep, beanName);</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        getBean(dep);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                <span class="string">"'"</span> + beanName + <span class="string">"' depends on missing bean '"</span> + dep + <span class="string">"'"</span>, ex);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 接下来就是创建bean实例了</span></span><br><span class="line">            <span class="keyword">if</span> (mbd.isSingleton()) {</span><br><span class="line">                <span class="comment">// 这里调用的是getSingleton重载方法之一，上文有介绍</span></span><br><span class="line">                sharedInstance = getSingleton(beanName, () -&gt; {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        <span class="comment">// createBean()方法很重要，其代码实现在AbstractAutowireCapableBeanFactory中，</span></span><br><span class="line">                        <span class="comment">// 后文会详细介绍，这里只要知道它创建并返回了一个bean（可能是FactoryBean）</span></span><br><span class="line">                        <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">catch</span> (BeansException ex) {</span><br><span class="line">                        destroySingleton(beanName);</span><br><span class="line">                        <span class="keyword">throw</span> ex;</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">                <span class="comment">// sharedInstance可能是普通bean也可能是FactoryBean，此处理方法见下文</span></span><br><span class="line">                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">            }</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) {</span><br><span class="line">                <span class="comment">// prototype类型的bean创建</span></span><br><span class="line">                Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 标记为正在创建的prototype类型的bean（通过prototypesCurrentlyInCreation属性）</span></span><br><span class="line">                    beforePrototypeCreation(beanName);</span><br><span class="line">                    <span class="comment">// 同样要调用createBean()方法</span></span><br><span class="line">                    prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">finally</span> {</span><br><span class="line">                    <span class="comment">// 移除bean的正在创建的prototype类型的标志</span></span><br><span class="line">                    afterPrototypeCreation(beanName);</span><br><span class="line">                }</span><br><span class="line">                bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">            }</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 其他scope类型的bean创建</span></span><br><span class="line">                String scopeName = mbd.getScope();</span><br><span class="line">                <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line">                <span class="keyword">if</span> (scope == <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No Scope registered for scope name '"</span> + scopeName + <span class="string">"'"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Object scopedInstance = scope.get(beanName, () -&gt; {</span><br><span class="line">                        beforePrototypeCreation(beanName);</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">finally</span> {</span><br><span class="line">                            afterPrototypeCreation(beanName);</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line">                    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">catch</span> (IllegalStateException ex) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</span><br><span class="line">                            <span class="string">"Scope '"</span> + scopeName + <span class="string">"' is not active for the current thread; consider "</span> +</span><br><span class="line">                            <span class="string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,</span><br><span class="line">                            ex);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) {</span><br><span class="line">            <span class="comment">// 发生异常，移除该bean的已创建标志（从alreadyCreated中移除）</span></span><br><span class="line">            cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 检查需要的类型是否和bean instance的实际类型匹配</span></span><br><span class="line">    <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; !requiredType.isInstance(bean)) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// bean的实际类型不匹配，需要使用TypeConverter转换成指定类型，否则会抛异常</span></span><br><span class="line">            T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">            <span class="keyword">if</span> (convertedBean == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> convertedBean;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (TypeMismatchException ex) {</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">                logger.trace(<span class="string">"Failed to convert bean '"</span> + name + <span class="string">"' to required type '"</span> +</span><br><span class="line">                        ClassUtils.getQualifiedName(requiredType) + <span class="string">"'"</span>, ex);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> (T) bean;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到<code>doGetBean()</code>方法还是很长，好在逻辑层次很清晰。先是从单例缓存中寻找；再是如果当前工厂不含有该bean定义且父工厂不为空则委托父工厂获取bean；再是保证bean定义中<em>depends-on</em>上的依赖都先于此bean初始化；然后就是根据bean的scope类型获取bean（都需要经过<code>createBean()</code>方法创建）；最后就是根据需要是否转换bean的Class类型。</p>
<p>上面获取的<em>sharedInstance</em>可能是普通bean或者是<code>FactoryBean</code>，都需要经过<code>getObjectForBeanInstance()</code>的处理。</p>
<h4 id="getObjectForBeanInstance"><a href="#getObjectForBeanInstance" class="headerlink" title="getObjectForBeanInstance"></a>getObjectForBeanInstance</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 从给定的beanInstance参数中获取bean，beanInstance可以是bean本身，也可能是个FactoryBean */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectForBeanInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            Object beanInstance, String name, String beanName, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>{</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 用户通过名称'&amp;xxx'想要获取FactoryBean本身，如果beanInstance不是一个FactoryBean，则会抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name)) {</span><br><span class="line">            <span class="keyword">if</span> (beanInstance <span class="keyword">instanceof</span> NullBean) {</span><br><span class="line">                <span class="keyword">return</span> beanInstance;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean)) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanIsNotAFactoryException(beanName, beanInstance.getClass());</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (mbd != <span class="keyword">null</span>) {</span><br><span class="line">                mbd.isFactoryBean = <span class="keyword">true</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> beanInstance;</span><br><span class="line">        }</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 到这里我们可以确定用户要获取的是bean对象</span></span><br><span class="line">        <span class="comment">// 如果beanInstance是FactoryBean，则我们使用它来创建bean;</span></span><br><span class="line">        <span class="comment">// 否则beanInstance本身就是bean，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!(beanInstance <span class="keyword">instanceof</span> FactoryBean)) {</span><br><span class="line">            <span class="keyword">return</span> beanInstance;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// beanInstance是一个FactoryBean</span></span><br><span class="line">        Object object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mbd != <span class="keyword">null</span>) {</span><br><span class="line">            mbd.isFactoryBean = <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 从缓存中获取FactoryBean创建的对象</span></span><br><span class="line">            object = getCachedObjectForFactoryBean(beanName);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 程序到这里表明需要从FactoryBean中构建bean</span></span><br><span class="line">            FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;</span><br><span class="line">            <span class="keyword">if</span> (mbd == <span class="keyword">null</span> &amp;&amp; containsBeanDefinition(beanName)) {</span><br><span class="line">                <span class="comment">// 获取合并的bean定义，会将BeanDefiniton转换成RootBeanDefinition</span></span><br><span class="line">                mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">boolean</span> synthetic = (mbd != <span class="keyword">null</span> &amp;&amp; mbd.isSynthetic());</span><br><span class="line">            <span class="comment">// 从FactoryBean中获取对象，包括后置处理等，上文有详细分析</span></span><br><span class="line">            object = getObjectFromFactoryBean(factory, beanName, !synthetic);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 返回FactoryBean中的bean实例</span></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里处理的逻辑很清楚，根据调用参数是否有<code>&amp;</code>前缀判断用户是想要的是<code>FactoryBean</code>本身还是其构建的bean，然后根据<em>beanInstance</em>是普通bean还是<code>FactoryBean</code>的情况区分。</p>
<p><strong>这里值得注意的是，如果是<code>FactoryBean</code>那么获取bean的时候会调用<code>getObjectFromFactoryBean</code>，这个方法会有bean的后置处理；那么如果是普通bean呢？</strong>猜测普通bean是在<code>createBean()</code>那一步进行了后置处理，这里先留个疑问。</p>
<hr>
<h2 id="AutowireCapableBeanFactory"><a href="#AutowireCapableBeanFactory" class="headerlink" title="AutowireCapableBeanFactory"></a><code>AutowireCapableBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">BeanFactory</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p>扩展了自动装配的能力。</p>
<h3 id="特性："><a href="#特性：" class="headerlink" title="特性："></a>特性：</h3><ul>
<li>该接口主要供spring框架内部使用</li>
<li>注意<code>ApplicationContext</code>并没有实现此接口，但有<code>getAutowireCapableBeanFactory()</code>方法</li>
<li><code>BeanFactoryAware</code>传入的工厂可通过强制转换成<code>AutowireCapableBeanFactory</code></li>
<li>有<code>createBean()</code>、<code>autowireBean()</code>、<code>configureBean()</code>方法</li>
<li>有<code>initializeBean()</code>、<code>applyBeanPostProcessorsBeforeInitialization()</code>、<code>applyBeanPostProcessorsAfterInitialization()</code>和<code>destroyBean</code>等方法</li>
</ul>
<hr>
<h2 id="AbstractAutowireCapableBeanFactory"><a href="#AbstractAutowireCapableBeanFactory" class="headerlink" title="AbstractAutowireCapableBeanFactory"></a><code>AbstractAutowireCapableBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p>在<code>AbstractBeanFactory</code>的能力上实现了<code>AutowireCapableBeanFactory</code>接口，提供了bean创建、属性填充、装配、初始化、处理运行时bean引用、调用初始化方法等。支持通过构造器注入、属性注入（名称或类型）。该类的在实现上较为复杂，因为是实际上创建bean的地方，需要考虑各种情况以及兼顾各种扩展点。</p>
<h3 id="特性-2"><a href="#特性-2" class="headerlink" title="特性"></a>特性</h3><ol>
<li>可指定实例化bean的策略，默认是<code>CglibSubclassingInstantiationStrategy</code></li>
<li>方法参数名称解析策略</li>
<li>可设置依赖检查或者自动注入中被忽略的类型或者接口</li>
<li>缓存未完成的<code>FactoryBean</code>实例（<code>BeanWrapper</code>）</li>
<li>缓存每个工厂类的候选工厂方法</li>
<li>缓存筛选的<code>PropertyDescriptors</code></li>
</ol>
<h3 id="重要方法-3"><a href="#重要方法-3" class="headerlink" title="重要方法"></a>重要方法</h3><h4 id="createBean"><a href="#createBean" class="headerlink" title="createBean"></a>createBean</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此类的中心方法，创建一个bean实例并填充，应用后置处理等</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeanCreationException </span>{</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">        logger.trace(<span class="string">"Creating instance of bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">    }</span><br><span class="line">    RootBeanDefinition mbdToUse = mbd;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 解析Class</span></span><br><span class="line">    <span class="comment">// 在动态解析Class的情况下，克隆bean定义</span></span><br><span class="line">    Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedClass != <span class="keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="keyword">null</span>) {</span><br><span class="line">        mbdToUse = <span class="keyword">new</span> RootBeanDefinition(mbd);</span><br><span class="line">        mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      	<span class="comment">// 准备方法覆盖(lookup-method和replace-method)</span></span><br><span class="line">        mbdToUse.prepareMethodOverrides();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionValidationException ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(mbdToUse.getResourceDescription(),</span><br><span class="line">                beanName, <span class="string">"Validation of method overrides failed"</span>, ex);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 给与BeanPostProcessors一个机会返回代理对象而不是实例本身(InstantiationAwareBeanPostProcessor)</span></span><br><span class="line">        Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">                <span class="string">"BeanPostProcessor before instantiation of bean failed"</span>, ex);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      	<span class="comment">// 若bean没有被代理，创建bean实例本身</span></span><br><span class="line">        Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">            logger.trace(<span class="string">"Finished creating instance of bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) {</span><br><span class="line">        <span class="comment">// A previously detected exception with proper bean creation context already,</span></span><br><span class="line">        <span class="comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span></span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                mbdToUse.getResourceDescription(), beanName, <span class="string">"Unexpected exception during bean creation"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>此方法没太复杂的逻辑，创建的逻辑都委托给了<code>doCreateBean</code>方法，而在创建前给与<code>InstantiationAwareBeanPostProcessor</code>一个机会返回代理对象而不是实例本身。</p>
<h4 id="doCreateBean"><a href="#doCreateBean" class="headerlink" title="doCreateBean"></a>doCreateBean</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeanCreationException </span>{</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 实例化bean</span></span><br><span class="line">		BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mbd.isSingleton()) {</span><br><span class="line">      		<span class="comment">// 检查是否有FactoryBean的BeanWrapper缓存（缓存是在类型检查的时候生成）</span></span><br><span class="line">			instanceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) {</span><br><span class="line">      		<span class="comment">// 缓存中没有，使用实例化策略（工厂方法、构造器注入等），创建指定bean的实例</span></span><br><span class="line">			instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">final</span> Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">		Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">		<span class="keyword">if</span> (beanType != NullBean.class) {</span><br><span class="line">			mbd.resolvedTargetType = beanType;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Allow post-processors to modify the merged bean definition.</span></span><br><span class="line">		<span class="keyword">synchronized</span> (mbd.postProcessingLock) {</span><br><span class="line">			<span class="keyword">if</span> (!mbd.postProcessed) {</span><br><span class="line">				<span class="keyword">try</span> {</span><br><span class="line">          			<span class="comment">// 应用MergedBeanDefinitionPostProcessor</span></span><br><span class="line">					applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">							<span class="string">"Post-processing of merged bean definition failed"</span>, ex);</span><br><span class="line">				}</span><br><span class="line">				mbd.postProcessed = <span class="keyword">true</span>;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 是否需要提前曝光未初始化完全的对象</span></span><br><span class="line">		<span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">				isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">		<span class="keyword">if</span> (earlySingletonExposure) {</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">				logger.trace(<span class="string">"Eagerly caching bean '"</span> + beanName +</span><br><span class="line">						<span class="string">"' to allow for resolving potential circular references"</span>);</span><br><span class="line">			}</span><br><span class="line">      		<span class="comment">// 将未初始化完全的bean实例放入ObjectFactory中（第三级缓存），</span></span><br><span class="line">      		<span class="comment">// getEarlyBeanReference方法主要应用SmartInstantiationAwareBeanPostProcessor.getEarlyBeanReference方法</span></span><br><span class="line">      		<span class="comment">// 我们熟知的aop就是在这里进行织入的</span></span><br><span class="line">			addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Initialize the bean instance.</span></span><br><span class="line">		Object exposedObject = bean;</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">      		<span class="comment">// 对bean的各项属性进行填充注入</span></span><br><span class="line">			populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">      		<span class="comment">// 调用初始化方法：invokeAwareMethods-&gt;postProcessBeforeInitialization-&gt;init-method-&gt;postProcessAfterInitialization</span></span><br><span class="line">			exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">			<span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) {</span><br><span class="line">				<span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">						mbd.getResourceDescription(), beanName, <span class="string">"Initialization of bean failed"</span>, ex);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 这里检测循环依赖</span></span><br><span class="line">		<span class="keyword">if</span> (earlySingletonExposure) {</span><br><span class="line">			Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">      		<span class="comment">// earlySingletonReference只有在检测到循环依赖的情况下才不为空</span></span><br><span class="line">			<span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) {</span><br><span class="line">        		<span class="comment">// 如果exposedObject没有被增强</span></span><br><span class="line">				<span class="keyword">if</span> (exposedObject == bean) {</span><br><span class="line">					exposedObject = earlySingletonReference;</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) {</span><br><span class="line">					String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">					Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">					<span class="keyword">for</span> (String dependentBean : dependentBeans) {</span><br><span class="line">            			<span class="comment">// 检测依赖</span></span><br><span class="line">						<span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) {</span><br><span class="line">							actualDependentBeans.add(dependentBean);</span><br><span class="line">						}</span><br><span class="line">					}</span><br><span class="line">          			<span class="comment">// 因为bean创建后，其所依赖的bean一定是已经创建的，actualDependentBeans不为空则表示当前 bean创建后其依赖的bean却没有没全部创建完，也就是说存在循环依赖</span></span><br><span class="line">					<span class="keyword">if</span> (!actualDependentBeans.isEmpty()) {</span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</span><br><span class="line">								<span class="string">"Bean with name '"</span> + beanName + <span class="string">"' has been injected into other beans ["</span> +</span><br><span class="line">								StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">								<span class="string">"] in its raw version as part of a circular reference, but has eventually been "</span> +</span><br><span class="line">								<span class="string">"wrapped. This means that said other beans do not use the final version of the "</span> +</span><br><span class="line">								<span class="string">"bean. This is often the result of over-eager type matching - consider using "</span> +</span><br><span class="line">								<span class="string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span>);</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Register bean as disposable.</span></span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">      		<span class="comment">// 根据scope注册DisposableBean</span></span><br><span class="line">			registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (BeanDefinitionValidationException ex) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">					mbd.getResourceDescription(), beanName, <span class="string">"Invalid destruction signature"</span>, ex);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> exposedObject;</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>doCreateBean</code>是创建bean的地方。包括实例化bean、填充bean、调用一些初始化方法、循环依赖检测等。</p>
<h4 id="createBeanInstance"><a href="#createBeanInstance" class="headerlink" title="createBeanInstance"></a>createBeanInstance</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为指定的bean创建新的bean实例，其使用合适的实例化策略，比如工厂方法、构造器注入、或者简单实例化</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">createBeanInstance</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span> </span>{</span><br><span class="line">		<span class="comment">// 解析bean的Class</span></span><br><span class="line">		Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (beanClass != <span class="keyword">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) {</span><br><span class="line">      		<span class="comment">// bean访问修饰符验证</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">					<span class="string">"Bean class isn't public, and non-public access not allowed: "</span> + beanClass.getName());</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();</span><br><span class="line">		<span class="keyword">if</span> (instanceSupplier != <span class="keyword">null</span>) {</span><br><span class="line">      		<span class="comment">// 如果bean定义中提供了Supplier函数，则使用Supplier函数生成bean，然后包装成BeanWrapper</span></span><br><span class="line">			<span class="keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mbd.getFactoryMethodName() != <span class="keyword">null</span>) {</span><br><span class="line">      		<span class="comment">// 如果bean定义中提供了工厂方法，则使用工厂方法生成BeanWrapper</span></span><br><span class="line">			<span class="keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 再次创建同样的bean，提供短路运算</span></span><br><span class="line">		<span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">boolean</span> autowireNecessary = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (args == <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">synchronized</span> (mbd.constructorArgumentLock) {</span><br><span class="line">        		<span class="comment">// 如果已经解析过构造方法</span></span><br><span class="line">				<span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="keyword">null</span>) {</span><br><span class="line">					resolved = <span class="keyword">true</span>;</span><br><span class="line">					autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (resolved) {</span><br><span class="line">      		<span class="comment">// 到这里是短路</span></span><br><span class="line">			<span class="keyword">if</span> (autowireNecessary) {</span><br><span class="line">       			 <span class="comment">// 如果构造函数已经解析，则使用已解析的构造函数</span></span><br><span class="line">				<span class="keyword">return</span> autowireConstructor(beanName, mbd, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">        		<span class="comment">// 使用InstantiationStrategy选用DeclaredConstructor构造</span></span><br><span class="line">				<span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从SmartInstantiationAwareBeanPostProcessor解析候选的构造函数</span></span><br><span class="line">		Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">		<span class="keyword">if</span> (ctors != <span class="keyword">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">				mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) {</span><br><span class="line">      		<span class="comment">// 使用构造函数自动注入</span></span><br><span class="line">			<span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		ctors = mbd.getPreferredConstructors();</span><br><span class="line">		<span class="keyword">if</span> (ctors != <span class="keyword">null</span>) {</span><br><span class="line">      		<span class="comment">// 使用偏好的构造函数注入（RootBeanDefinition中定义）</span></span><br><span class="line">			<span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="keyword">null</span>);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使用默认的构造函数注入</span></span><br><span class="line">		<span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

<p>此方法选用合适的策略来创建bean。可以看出优先使用<code>Supplier</code>，再是工厂方法，再是带参构造函数，最后才是无参构造函数。其具体的构造函数注入比较复杂，就不分析，其实就是根据参数的最大匹配来选择最合适的构造函数。</p>
<h4 id="getEarlyBeanReference"><a href="#getEarlyBeanReference" class="headerlink" title="getEarlyBeanReference"></a>getEarlyBeanReference</h4><p>此方法调用了<code>SmartInstantiationAwareBeanPostProcessor.getEarlyBeanReference</code>，查看实现类中有<code>AbstractAutoProxyCreator</code>，即我们熟知的aop，如果有增强那么这一步放入的将会是增强后的对象。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getEarlyBeanReference</span><span class="params">(String beanName, RootBeanDefinition mbd, Object bean)</span> </span>{</span><br><span class="line">		Object exposedObject = bean;</span><br><span class="line">		<span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) {</span><br><span class="line">			<span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) {</span><br><span class="line">				<span class="keyword">if</span> (bp <span class="keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) {</span><br><span class="line">					SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">          			<span class="comment">// 调用getEarlyBeanReference对早期对象进行处理</span></span><br><span class="line">					exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> exposedObject;</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="populateBean"><a href="#populateBean" class="headerlink" title="populateBean"></a>populateBean</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">populateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> BeanWrapper bw)</span> </span>{</span><br><span class="line">    	<span class="comment">// BeanWrapper检查（查看调用处，未发现为null的情况）</span></span><br><span class="line">		<span class="keyword">if</span> (bw == <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">if</span> (mbd.hasPropertyValues()) {</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">						mbd.getResourceDescription(), beanName, <span class="string">"Cannot apply property values to null instance"</span>);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				<span class="comment">// Skip property population phase for null instance.</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span></span><br><span class="line">		<span class="comment">// state of the bean before properties are set. This can be used, for example,</span></span><br><span class="line">		<span class="comment">// to support styles of field injection.</span></span><br><span class="line">		<span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) {</span><br><span class="line">			<span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) {</span><br><span class="line">				<span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) {</span><br><span class="line">					InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">					<span class="keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) {</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> resolvedAutowireMode = mbd.getResolvedAutowireMode();</span><br><span class="line">		<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) {</span><br><span class="line">			MutablePropertyValues newPvs = <span class="keyword">new</span> MutablePropertyValues(pvs);</span><br><span class="line">			<span class="comment">// Add property values based on autowire by name if applicable.</span></span><br><span class="line">			<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME) {</span><br><span class="line">				autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// Add property values based on autowire by type if applicable.</span></span><br><span class="line">			<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_TYPE) {</span><br><span class="line">				autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">			}</span><br><span class="line">			pvs = newPvs;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">		<span class="keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">		PropertyDescriptor[] filteredPds = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (hasInstAwareBpps) {</span><br><span class="line">			<span class="keyword">if</span> (pvs == <span class="keyword">null</span>) {</span><br><span class="line">				pvs = mbd.getPropertyValues();</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) {</span><br><span class="line">				<span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) {</span><br><span class="line">					InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">					PropertyValues pvsToUse = ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);</span><br><span class="line">					<span class="keyword">if</span> (pvsToUse == <span class="keyword">null</span>) {</span><br><span class="line">						<span class="keyword">if</span> (filteredPds == <span class="keyword">null</span>) {</span><br><span class="line">							filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">						}</span><br><span class="line">						pvsToUse = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">						<span class="keyword">if</span> (pvsToUse == <span class="keyword">null</span>) {</span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line">						}</span><br><span class="line">					}</span><br><span class="line">					pvs = pvsToUse;</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (needsDepCheck) {</span><br><span class="line">			<span class="keyword">if</span> (filteredPds == <span class="keyword">null</span>) {</span><br><span class="line">				filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">			}</span><br><span class="line">			checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pvs != <span class="keyword">null</span>) {</span><br><span class="line">			applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">		}</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="initializeBean"><a href="#initializeBean" class="headerlink" title="initializeBean"></a>initializeBean</h4><p>此方法执行Bean创建过程的初始化流程，其顺序为：<code>Aware</code>-&gt;<code>postProcessBeforeInitialization</code>-&gt;<code>afterPropertiesSet</code>-&gt;<code>init-method</code>-&gt;<code>postProcessAfterInitialization</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">initializeBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) {</span><br><span class="line">			AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; {</span><br><span class="line">				invokeAwareMethods(beanName, bean);</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			}, getAccessControlContext());</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 调用Aware方法，包括BeanNameAware、BeanClassLoaderAware、BeanFactoryAware</span></span><br><span class="line">			invokeAwareMethods(beanName, bean);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		Object wrappedBean = bean;</span><br><span class="line">		<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) {</span><br><span class="line">            <span class="comment">// 调用所有的BeanPostProcessor.postProcessBeforeInitialization方法</span></span><br><span class="line">			wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 如果bean是InitializingBean，则调用afterPropertiesSet</span></span><br><span class="line">            <span class="comment">// 然后调用bean定义中的'init-method'</span></span><br><span class="line">			invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">					(mbd != <span class="keyword">null</span> ? mbd.getResourceDescription() : <span class="keyword">null</span>),</span><br><span class="line">					beanName, <span class="string">"Invocation of init method failed"</span>, ex);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) {</span><br><span class="line">            <span class="comment">// 调用所有的BeanPostProcessor.postProcessAfterInitialization方法</span></span><br><span class="line">			wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> wrappedBean;</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>



<hr>
<h2 id="ListableBeanFactory"><a href="#ListableBeanFactory" class="headerlink" title="ListableBeanFactory"></a><code>ListableBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ListableBeanFactory</span> <span class="keyword">extends</span> <span class="title">BeanFactory</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p>从命名来看，这个接口就是用来罗列满足某些条件的bean的。</p>
<h3 id="特性-3"><a href="#特性-3" class="headerlink" title="特性"></a>特性</h3><ul>
<li>查询bean定义只考虑当前工厂，不考虑父工厂，也不考虑手动注册的单例</li>
<li>通过<code>ResolvableType</code>查询，同样不考虑父工厂，会考虑各种类型的bean，包括<code>FactoryBean</code>、singleton和prototype</li>
<li>通过type查找，同上</li>
<li>还可以通过<code>Annotation</code>查找</li>
</ul>
<hr>
<h2 id="ConfigurableListableBeanFactory"><a href="#ConfigurableListableBeanFactory" class="headerlink" title="ConfigurableListableBeanFactory"></a><code>ConfigurableListableBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableListableBeanFactory</span></span></span><br><span class="line"><span class="class">      <span class="keyword">extends</span> <span class="title">ListableBeanFactory</span>, <span class="title">AutowireCapableBeanFactory</span>, <span class="title">ConfigurableBeanFactory</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p>给大多数可罗列的bean工厂实现的配置接口。除了继承<code>ConfigurableBeanFactory</code>，还提供了分析和修改bean定义和提前实例化单例。此接口主要供框架内使用（<code>ApplicationContext</code>）。</p>
<hr>
<h2 id="BeanDefinitionRegistry"><a href="#BeanDefinitionRegistry" class="headerlink" title="BeanDefinitionRegistry"></a><code>BeanDefinitionRegistry</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistry</span> <span class="keyword">extends</span> <span class="title">AliasRegistry</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p>注册bean definition的接口。</p>
<hr>
<h2 id="DefaultListableBeanFactory"><a href="#DefaultListableBeanFactory" class="headerlink" title="DefaultListableBeanFactory"></a><code>DefaultListableBeanFactory</code></h2><blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultListableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractAutowireCapableBeanFactory</span></span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">ConfigurableListableBeanFactory</span>, <span class="title">BeanDefinitionRegistry</span>, <span class="title">Serializable</span></span></span><br></pre></td></tr></tbody></table></figure></div>
</blockquote>
<p><code>ConfigurableListableBeanFactory</code>接口的默认实现。基本上已经是个成熟的bean工厂了，除了解析bean定义，已经具备了bean factory的所有能力了。其也是<code>ApplicationContext</code>体系中默认使用的工厂。</p>
<h3 id="特性-4"><a href="#特性-4" class="headerlink" title="特性"></a>特性</h3><ul>
<li>支持序列化</li>
<li>允许bean定义覆盖、允许提前加载bean的class</li>
<li>作为<code>BeanDefinition</code>的容器并记录注册顺序</li>
<li>记录依赖的Class type到bean name的映射关系</li>
<li>记录手动注册的singleton和其顺序</li>
<li>记录冻结的配置快照</li>
<li><strong>candidate查找的顺序是</strong>：先通过<code>getBeanNamesForType</code>查找所有候选者-&gt;如果只有一个则返回-&gt;bean定义中的primary属性(唯一)-&gt;<code>dependencyComparator</code>中第一的优先级(唯一)</li>
</ul>
<h3 id="重要方法-4"><a href="#重要方法-4" class="headerlink" title="重要方法"></a>重要方法</h3><h4 id="resolveBean"><a href="#resolveBean" class="headerlink" title="resolveBean"></a>resolveBean</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; requiredType, <span class="meta">@Nullable</span> Object... args)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">		Assert.notNull(requiredType, <span class="string">"Required type must not be null"</span>);</span><br><span class="line">    	<span class="comment">// 'getBean'是用户常使用的方法，其内部调用的是'resolveBean'</span></span><br><span class="line">		Object resolved = resolveBean(ResolvableType.forRawClass(requiredType), args, <span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (resolved == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 若没有找到对应的bean，则抛出异常</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NoSuchBeanDefinitionException(requiredType);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> (T) resolved;</span><br><span class="line">	}</span><br><span class="line"><span class="comment">// 下面是resolveBean的代码实现</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">resolveBean</span><span class="params">(ResolvableType requiredType, <span class="meta">@Nullable</span> Object[] args, <span class="keyword">boolean</span> nonUniqueAsNull)</span> </span>{</span><br><span class="line">    	<span class="comment">// 其又调用了'resovleNamedBean'</span></span><br><span class="line">    	<span class="comment">// NamedBeanHolder是个简单的bean载体，只用beanName和bean实例</span></span><br><span class="line">		NamedBeanHolder&lt;T&gt; namedBean = resolveNamedBean(requiredType, args, nonUniqueAsNull);</span><br><span class="line">		<span class="keyword">if</span> (namedBean != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">return</span> namedBean.getBeanInstance();</span><br><span class="line">		}</span><br><span class="line">    	<span class="comment">// 若Local没有找到，则到父工厂中寻找</span></span><br><span class="line">		BeanFactory parent = getParentBeanFactory();</span><br><span class="line">		<span class="keyword">if</span> (parent <span class="keyword">instanceof</span> DefaultListableBeanFactory) {</span><br><span class="line">            <span class="comment">// 若父工厂也是'DefaultListableBeanFactory'，则使用其'resolveBean'的返回值</span></span><br><span class="line">			<span class="keyword">return</span> ((DefaultListableBeanFactory) parent).resolveBean(requiredType, args, nonUniqueAsNull);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 若父工厂不是'DefaultListableBeanFactory'，则使用‘ObjectProvider’获取bean</span></span><br><span class="line">			ObjectProvider&lt;T&gt; parentProvider = parent.getBeanProvider(requiredType);</span><br><span class="line">			<span class="keyword">if</span> (args != <span class="keyword">null</span>) {</span><br><span class="line">				<span class="keyword">return</span> parentProvider.getObject(args);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">return</span> (nonUniqueAsNull ? parentProvider.getIfUnique() : parentProvider.getIfAvailable());</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="resolveNamedBean"><a href="#resolveNamedBean" class="headerlink" title="resolveNamedBean"></a>resolveNamedBean</h4><p>我们知道，<code>resolveBean()</code>实际是委托给了<code>resolveNamedBean()</code>获取bean的。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">NamedBeanHolder&lt;T&gt; <span class="title">resolveNamedBean</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			ResolvableType requiredType, <span class="meta">@Nullable</span> Object[] args, <span class="keyword">boolean</span> nonUniqueAsNull)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line"></span><br><span class="line">		Assert.notNull(requiredType, <span class="string">"Required type must not be null"</span>);</span><br><span class="line">    	<span class="comment">// 获取匹配指定类型的beanName，也就是候选者名称</span></span><br><span class="line">		String[] candidateNames = getBeanNamesForType(requiredType);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (candidateNames.length &gt; <span class="number">1</span>) {</span><br><span class="line">            <span class="comment">// 如果候选者有多个，则要先进行筛选</span></span><br><span class="line">			List&lt;String&gt; autowireCandidates = <span class="keyword">new</span> ArrayList&lt;&gt;(candidateNames.length);</span><br><span class="line">			<span class="keyword">for</span> (String beanName : candidateNames) {</span><br><span class="line">				<span class="keyword">if</span> (!containsBeanDefinition(beanName) || getBeanDefinition(beanName).isAutowireCandidate()) {</span><br><span class="line">                    <span class="comment">// 将BeanDefinition中'autowireCandidate'为false的过滤掉</span></span><br><span class="line">                    <span class="comment">// 这里的判断条件可能有些迷惑性，首先我们要明确bean的注册方式有BeanDefinition和</span></span><br><span class="line">                    <span class="comment">// 手动注册的方式，'!containsBeanDefinition(beanName)'为true说明是手动注册的</span></span><br><span class="line">                    <span class="comment">// 方式，当然是属于候选者</span></span><br><span class="line">					autowireCandidates.add(beanName);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">if</span> (!autowireCandidates.isEmpty()) {</span><br><span class="line">                <span class="comment">// 这里可以反向思考一下，如果所有候选者都被过滤掉了，那么可以不用过滤</span></span><br><span class="line">				candidateNames = StringUtils.toStringArray(autowireCandidates);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (candidateNames.length == <span class="number">1</span>) {</span><br><span class="line">            <span class="comment">// 候选者唯一，那么获取该bean即可</span></span><br><span class="line">			String beanName = candidateNames[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> NamedBeanHolder&lt;&gt;(beanName, (T) getBean(beanName, requiredType.toClass(), args));</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (candidateNames.length &gt; <span class="number">1</span>) {</span><br><span class="line">            <span class="comment">// 候选者存在多个，则需要判断优先级，先构造一个Map</span></span><br><span class="line">            <span class="comment">// beanName-&gt;beanInstance或者beanName-&gt;beanClass</span></span><br><span class="line">			Map&lt;String, Object&gt; candidates = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(candidateNames.length);</span><br><span class="line">			<span class="keyword">for</span> (String beanName : candidateNames) {</span><br><span class="line">				<span class="keyword">if</span> (containsSingleton(beanName) &amp;&amp; args == <span class="keyword">null</span>) {</span><br><span class="line">					Object beanInstance = getBean(beanName);</span><br><span class="line">					candidates.put(beanName, (beanInstance <span class="keyword">instanceof</span> NullBean ? <span class="keyword">null</span> : beanInstance));</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">else</span> {</span><br><span class="line">					candidates.put(beanName, getType(beanName));</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">            <span class="comment">// 获取具有'primary'属性的bean，注意两个或以上会抛异常</span></span><br><span class="line">			String candidateName = determinePrimaryCandidate(candidates, requiredType.toClass());</span><br><span class="line">			<span class="keyword">if</span> (candidateName == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// 如果没有’primary‘的bean，则按照优选级排序(@Priority)，取具有最高优先级的bean，注意相同优先级的bean也不能有两个或以上</span></span><br><span class="line">				candidateName = determineHighestPriorityCandidate(candidates, requiredType.toClass());</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">if</span> (candidateName != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// 找到最匹配的候选者，获取bean实例后返回</span></span><br><span class="line">				Object beanInstance = candidates.get(candidateName);</span><br><span class="line">				<span class="keyword">if</span> (beanInstance == <span class="keyword">null</span> || beanInstance <span class="keyword">instanceof</span> Class) {</span><br><span class="line">					beanInstance = getBean(candidateName, requiredType.toClass(), args);</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> NamedBeanHolder&lt;&gt;(candidateName, (T) beanInstance);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">if</span> (!nonUniqueAsNull) {</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> NoUniqueBeanDefinitionException(requiredType, candidates.keySet());</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="preInstantiateSingletons"><a href="#preInstantiateSingletons" class="headerlink" title="preInstantiateSingletons"></a>preInstantiateSingletons</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">			logger.trace(<span class="string">"Pre-instantiating singletons in "</span> + <span class="keyword">this</span>);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">  		<span class="comment">// 对'beanDefinitionNames'做一个快照，以允许注册新的beanDefinition</span></span><br><span class="line">		List&lt;String&gt; beanNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 初始化所有的非惰性的(non-lazy)单例bean</span></span><br><span class="line">		<span class="keyword">for</span> (String beanName : beanNames) {</span><br><span class="line">      		<span class="comment">// 获取RootBeanDifinition</span></span><br><span class="line">			RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">			<span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) {</span><br><span class="line">        		<span class="comment">// 对于非抽象的、单例的、非惰性的bean</span></span><br><span class="line">				<span class="keyword">if</span> (isFactoryBean(beanName)) {</span><br><span class="line">          			<span class="comment">// 如果'beanName'是一个FactoryBean，则获取这个FactoryBean</span></span><br><span class="line">					Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">          			<span class="comment">// 这里还需要再判断一下，因为有NullBean</span></span><br><span class="line">					<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) {</span><br><span class="line">						<span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">						<span class="keyword">boolean</span> isEagerInit;</span><br><span class="line">						<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) {</span><br><span class="line">							isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)</span><br><span class="line">											((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">									getAccessControlContext());</span><br><span class="line">						}</span><br><span class="line">						<span class="keyword">else</span> {</span><br><span class="line">              				<span class="comment">// 一般来说，FactoryBean的单例都是lazy-init的，然而如果是SmartFactoryBean，</span></span><br><span class="line">              				<span class="comment">// 且设置了eager init，则需要提前初始化</span></span><br><span class="line">							isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">									((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">						}</span><br><span class="line">						<span class="keyword">if</span> (isEagerInit) {</span><br><span class="line">							getBean(beanName);</span><br><span class="line">						}</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 若不是FactoryBean，则需要初始化</span></span><br><span class="line">					getBean(beanName);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 触发`SmartInitializingSingleton.afterSingletonsInstantiated`回调</span></span><br><span class="line">		<span class="keyword">for</span> (String beanName : beanNames) {</span><br><span class="line">			Object singletonInstance = getSingleton(beanName);</span><br><span class="line">			<span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) {</span><br><span class="line">				<span class="keyword">final</span> SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">				<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) {</span><br><span class="line">					AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; {</span><br><span class="line">						smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">					}, getAccessControlContext());</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">else</span> {</span><br><span class="line">					smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Kidon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kidon.fun/2021/10/04/spring-BeanFactory/">https://kidon.fun/2021/10/04/spring-BeanFactory/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kidon.fun">啓東のblogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/10/05/spring-ApplicationContext/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Spring源码学习—— ApplicationContext</span></div></a></div><div class="next-post pull_right"><a href="/2020/03/30/nexus-repo/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Nexus(Maven)仓库搭建和常见问题</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/10/05/spring-ApplicationContext/" title="Spring源码学习—— ApplicationContext"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-10-05</div><div class="relatedPosts_title">Spring源码学习—— ApplicationContext</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Kidon</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/canvas-nest.js"></script><script src="https://cdn.jsdelivr.net/npm/activate-power-mode/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = false;
POWERMODE.shake = true; 
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>